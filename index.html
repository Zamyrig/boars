<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport"
content="width=device-width, initial-scale=1.0, viewport-fit=cover, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="theme-color" content="#0a0a0c">
<meta name="mobile-web-app-capable" content="yes">
<title>WILD TUSK BRAWL</title>
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<style>
:root {
--bg: #0a0a0c;
--accent: #ff3e3e;
--gold: #ffcc00;
--text: #ffffff;
--card: rgba(18, 18, 20, 0.95);
--radius: 28px;
--win: #4cd964;
--lose: #ff3e3e;
--transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
--safe-top: env(safe-area-inset-top, 20px);
--safe-bottom: env(safe-area-inset-bottom, 34px);
--safe-left: env(safe-area-inset-left, 0px);
--safe-right: env(safe-area-inset-right, 0px);
}
body {
margin: 0;
font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
background: var(--bg);
color: var(--text);
overflow: hidden;
-webkit-font-smoothing: antialiased;
touch-action: manipulation;
padding-bottom: 0;
height: 100dvh;
width: 100vw;
}
.game-bg {
position: fixed;
top: 0;
left: 0;
width: 100%;
height: 100%;
background-size: cover;
background-position: center;
z-index: -2;
transition: filter 0.5s ease, transform 0.5s ease;
}
#bg-main {
background-image: url('assets/main_menu.png');
background-color: #1a1a1a;
}
#bg-fight {
background-image: url('assets/fight_field.png');
background-color: #000;
display: none;
}
#bg-inventory {
background-image: url('assets/inventory.png');
background-color: #0a0a0c;
display: none;
}
#bg-shop {
background-image: url('assets/shop.png');
background-color: #0a0a0c;
display: none;
}
.bg-overlay {
position: fixed;
top: 0;
left: 0;
width: 100%;
height: 100%;
background: rgba(0, 0, 0, 0.75);
z-index: -1;
opacity: 0;
transition: opacity 0.4s ease;
pointer-events: none;
backdrop-filter: blur(0px);
}
body.dimmed .bg-overlay {
opacity: 1;
backdrop-filter: blur(8px);
pointer-events: auto;
}
body.dimmed .game-bg {
filter: brightness(0.5);
transform: scale(1.05);
}
.screen {
display: none;
width: 100%;
height: 100%;
flex-direction: column;
align-items: center;
justify-content: center;
padding: 24px;
padding-top: calc(20px + var(--safe-top));
padding-bottom: calc(20px + var(--safe-bottom));
box-sizing: border-box;
position: absolute;
top: 0;
left: 0;
overflow-y: auto;
}
.active {
display: flex;
animation: screenIn 0.4s forwards;
}
@keyframes screenIn {
from {
opacity: 0;
transform: translateY(10px);
}
to {
opacity: 1;
transform: translateY(0);
}
}
#balance-header {
position: fixed;
top: calc(12px + var(--safe-top));
left: calc(16px + var(--safe-left));
background: rgba(0, 0, 0, 0.6);
backdrop-filter: blur(15px);
border: 1px solid rgba(255, 255, 255, 0.1);
padding: 10px 20px;
border-radius: 100px;
font-weight: 800;
color: var(--gold);
z-index: 1000;
display: flex;
align-items: center;
gap: 8px;
box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
}
/* --- –ê–ù–ò–ú–ê–¶–ò–Ø –°–ü–ò–°–ê–ù–ò–Ø (–í–´–õ–ï–¢ –ò–ó-–ü–û–î –ë–ê–õ–ê–ù–°–ê) --- */
#bet-deduction-notify {
position: absolute;
top: 100%;
left: 50%;
transform: translateX(-50%) translateY(-10px);
background: rgba(255, 62, 62, 0.95);
backdrop-filter: blur(15px);
border: 1px solid rgba(255, 255, 255, 0.2);
padding: 8px 16px;
border-radius: 100px;
font-weight: 800;
color: #fff;
font-size: 0.85rem;
white-space: nowrap;
opacity: 0;
visibility: hidden;
z-index: 999;
transition: opacity 0.3s ease, visibility 0.3s ease, transform 0.3s ease;
}
#bet-deduction-notify.show {
opacity: 1;
visibility: visible;
transform: translateX(-50%) translateY(25px);
}
/* --- –ö–û–ù–ï–¶ –ê–ù–ò–ú–ê–¶–ò–ò –°–ü–ò–°–ê–ù–ò–Ø --- */
.notification-toast {
position: fixed;
top: calc(12px + var(--safe-top));
left: 50%;
transform: translateX(-50%);
background: rgba(0, 0, 0, 0.85);
backdrop-filter: blur(15px);
border: 1px solid rgba(255, 255, 255, 0.15);
padding: 12px 24px;
border-radius: 20px;
color: white;
font-weight: 700;
font-size: 0.9rem;
z-index: 6000;
opacity: 0;
visibility: hidden;
transition: opacity 0.3s ease, visibility 0.3s ease, transform 0.3s ease;
box-shadow: 0 4px 20px rgba(0, 0, 0, 0.4);
text-align: center;
max-width: 80%;
width: fit-content;
}
.notification-toast.show {
opacity: 1;
visibility: visible;
transform: translateX(-50%) translateY(40px);
}
#rank-trigger,
#profile-trigger {
position: fixed;
bottom: calc(20px + var(--safe-bottom));
width: 68px;
height: 68px;
background: rgba(30, 30, 34, 0.92);
border: 1px solid rgba(255, 255, 255, 0.14);
border-radius: 50%;
display: flex;
align-items: center;
justify-content: center;
cursor: pointer;
z-index: 3000;
box-shadow: 0 10px 30px rgba(0, 0, 0, 0.6);
backdrop-filter: blur(10px);
transition: transform 0.2s, opacity 0.2s;
}
#rank-trigger:active,
#profile-trigger:active {
transform: scale(0.92);
}
#rank-trigger span {
font-size: 1.8rem;
}
#profile-trigger img {
width: 80%;
height: 80%;
border-radius: 50%;
object-fit: cover;
}
#profile-trigger {
right: calc(16px + var(--safe-right));
}
#rank-trigger {
right: calc(16px + 68px + 16px + var(--safe-right));
}
body:not(.show-main-screen) #rank-trigger,
body:not(.show-main-screen) #profile-trigger {
display: none;
}
body.show-main-screen #rank-trigger,
body.show-main-screen #profile-trigger {
display: flex;
}
.menu-buttons {
width: 100%;
max-width: 300px;
display: flex;
flex-direction: column;
gap: 16px;
margin-bottom: var(--safe-bottom);
}
.btn-wood {
background: #252528;
border: 1px solid rgba(255, 255, 255, 0.08);
color: #fff;
padding: 18px;
border-radius: 20px;
font-weight: 800;
font-size: 0.95rem;
text-transform: uppercase;
letter-spacing: 1.2px;
cursor: pointer;
transition: var(--transition);
text-align: center;
box-shadow: 0 4px 0px #151517;
position: relative;
top: 0;
user-select: none;
-webkit-tap-highlight-color: transparent;
}
.btn-wood:active {
top: 2px;
box-shadow: 0 1px 0px #151517;
background: #2a2a2d;
}
.btn-wood:disabled {
opacity: 0.5;
pointer-events: none;
cursor: not-allowed;
box-shadow: none;
top: 0;
}
.btn-play {
background: var(--gold);
color: #000;
border: none;
box-shadow: 0 4px 0px #cca300;
}
.btn-play:active {
background: #e6b800;
box-shadow: 0 1px 0px #cca300;
}
.card {
background: var(--card);
padding: 32px 24px;
border-radius: var(--radius);
border: 1px solid rgba(255, 255, 255, 0.12);
width: 100%;
max-width: 340px;
backdrop-filter: blur(25px);
box-shadow: 0 25px 50px rgba(0, 0, 0, 0.7);
transform-origin: center bottom;
animation: cardPop 0.4s cubic-bezier(0.18, 0.89, 0.32, 1.28);
position: relative;
}
@keyframes cardPop {
from {
opacity: 0;
transform: scale(0.9) translateY(20px);
}
to {
opacity: 1;
transform: scale(1) translateY(0);
}
}
.stat-grid {
display: grid;
grid-template-columns: 1fr 1fr;
gap: 14px;
margin: 24px 0;
}
.stat-item {
background: rgba(255, 255, 255, 0.04);
padding: 16px;
border-radius: 20px;
text-align: center;
border: 1px solid rgba(255, 255, 255, 0.05);
}
.stat-val {
font-size: 1.2rem;
font-weight: 900;
display: block;
margin-bottom: 4px;
}
.stat-lbl {
font-size: 0.7rem;
opacity: 0.4;
text-transform: uppercase;
font-weight: 700;
}
input {
background: rgba(255, 255, 255, 0.06);
border: 1px solid rgba(255, 255, 255, 0.1);
color: #fff;
padding: 20px;
border-radius: 18px;
width: 100%;
box-sizing: border-box;
font-size: 1.2rem;
text-align: center;
margin-bottom: 16px;
font-weight: 700;
outline: none;
transition: border-color 0.2s;
}
input:focus {
border-color: var(--gold);
}
input:disabled {
opacity: 0.5;
cursor: not-allowed;
}
.arena {
position: absolute;
bottom: 25%;
width: 100%;
display: flex;
justify-content: space-around;
align-items: flex-end;
perspective: 1000px;
padding-bottom: var(--safe-bottom);
}
.boar-container {
width: 38%;
display: flex;
flex-direction: column;
align-items: center;
gap: 20px;
position: relative;
}
.boar-container.hit {
animation: flashRed 0.25s ease-out;
}
@keyframes flashRed {
0% {
filter: brightness(1);
}
50% {
filter: brightness(1.8) sepia(0.3) saturate(2);
transform: scale(1.1) rotate(2deg);
}
100% {
filter: brightness(1);
}
}
.dmg-popup {
position: absolute;
top: -40px;
color: #ff3e3e;
font-size: 2.2rem;
font-weight: 900;
text-shadow: 0 4px 12px rgba(0, 0, 0, 0.9);
pointer-events: none;
animation: flyUp 0.7s cubic-bezier(0.22, 1, 0.36, 1) forwards;
z-index: 100;
}
@keyframes flyUp {
0% {
opacity: 0;
transform: translateY(0) scale(0.5);
}
30% {
opacity: 1;
transform: translateY(-20px) scale(1.3);
}
100% {
opacity: 0;
transform: translateY(-90px) scale(1);
}
}
.hp-bar-box {
width: 100%;
max-width: 130px;
}
.hp-bar {
width: 100%;
background: rgba(255, 255, 255, 0.1);
height: 8px;
border-radius: 12px;
overflow: hidden;
position: relative;
box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.3);
}
.hp-fill {
height: 100%;
background: linear-gradient(90deg, #4cd964, #a0ffaf);
transition: width 0.4s cubic-bezier(0.33, 1, 0.68, 1);
width: 100%;
}
.hp-txt {
color: #fff;
font-size: 1.2rem;
font-weight: 900;
text-align: center;
margin-bottom: 8px;
text-shadow: 0 2px 8px rgba(0, 0, 0, 0.5);
}
.boar-unit {
width: 100%;
filter: drop-shadow(0 15px 25px rgba(0, 0, 0, 0.6));
}
.boar-unit img {
width: 100%;
height: auto;
display: block;
}
#boar1-img {
transform: scaleX(-1);
}
#fight-log {
position: absolute;
bottom: calc(15% + var(--safe-bottom));
background: rgba(0, 0, 0, 0.7);
backdrop-filter: blur(12px);
padding: 12px 28px;
border-radius: 100px;
font-weight: 700;
font-size: 0.9rem;
color: #fff;
border: 1px solid rgba(255, 255, 255, 0.15);
z-index: 20;
box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
max-width: 80%;
text-align: center;
}
#result-overlay {
position: fixed;
inset: 0;
background: rgba(0, 0, 0, 0.8);
z-index: 5000;
display: none;
flex-direction: column;
align-items: center;
justify-content: center;
backdrop-filter: blur(12px);
padding: 24px;
padding-top: calc(24px + var(--safe-top));
padding-bottom: calc(24px + var(--safe-bottom));
padding-left: calc(24px + var(--safe-left));
padding-right: calc(24px + var(--safe-right));
box-sizing: border-box;
overflow-y: auto;
}
#result-card {
background: var(--card);
width: 100%;
max-width: 320px;
border-radius: 40px;
padding: 40px 24px;
text-align: center;
border: 1px solid rgba(255, 255, 255, 0.15);
transform: translateY(60px) scale(0.9);
opacity: 0;
transition: all 0.5s cubic-bezier(0.18, 0.89, 0.32, 1.28);
box-shadow: 0 40px 80px rgba(0, 0, 0, 0.9);
position: relative;
margin: auto;
display: flex;
flex-direction: column;
align-items: center;
}
#result-card.active {
transform: translateY(0) scale(1);
opacity: 1;
}
.res-icon {
font-size: 5rem;
margin-bottom: 20px;
display: block;
filter: drop-shadow(0 10px 20px rgba(0, 0, 0, 0.3));
}
.res-title {
font-size: 2.2rem;
font-weight: 900;
text-transform: uppercase;
margin: 0 0 12px 0;
word-break: break-word;
line-height: 1;
}
.res-sum {
font-size: 1.6rem;
font-weight: 800;
opacity: 0.9;
margin-bottom: 30px;
}
.res-btn {
background: #fff;
color: #000;
border: none;
padding: 18px 0;
width: 100%;
border-radius: 20px;
font-weight: 900;
font-size: 1.1rem;
text-transform: uppercase;
cursor: pointer;
box-shadow: 0 10px 30px rgba(255, 255, 255, 0.15);
transition: transform 0.2s;
display: flex;
align-items: center;
justify-content: center;
}
.res-btn:active {
transform: scale(0.96);
}
.close-x {
position: absolute;
top: 16px;
right: 16px;
width: 36px;
height: 36px;
background: rgba(255, 255, 255, 0.08);
border-radius: 50%;
display: flex;
align-items: center;
justify-content: center;
border: none;
color: rgba(255, 255, 255, 0.6);
font-size: 24px;
line-height: 1;
cursor: pointer;
transition: background 0.2s;
}
.close-x:active {
background: rgba(255, 255, 255, 0.2);
}
.rank-item {
display: flex;
justify-content: space-between;
align-items: center;
padding: 18px;
background: rgba(255, 255, 255, 0.04);
border-radius: 20px;
margin-bottom: 12px;
cursor: pointer;
border: 1px solid rgba(255, 255, 255, 0.05);
transition: background 0.2s;
}
.rank-item:active {
transform: scale(0.97);
background: rgba(255, 255, 255, 0.08);
}
.rank-item.current-user-highlight {
outline: 2px solid var(--gold);
outline-offset: -2px;
}
#your-rank {
font-size: 0.9rem;
opacity: 0.7;
margin-bottom: 16px;
text-align: center;
font-weight: 700;
}
#user-modal {
position: fixed;
inset: 0;
background: rgba(0, 0, 0, 0.4);
z-index: 4000;
display: none;
flex-direction: column;
align-items: center;
justify-content: center;
padding: 24px;
box-sizing: border-box;
backdrop-filter: blur(15px);
padding-bottom: calc(24px + var(--safe-bottom));
}
.toggle-switch {
position: relative;
display: inline-block;
width: 120px;
height: 40px;
}
.toggle-switch input {
opacity: 0;
width: 0;
height: 0;
}
.slider {
position: absolute;
cursor: pointer;
top: 0;
left: 0;
right: 0;
bottom: 0;
background-color: var(--lose);
transition: background-color 0.4s;
border-radius: 20px;
}
.slider:before {
position: absolute;
content: "";
height: 32px;
width: 32px;
left: 4px;
bottom: 4px;
background-color: #fff;
transition: transform 0.4s;
border-radius: 50%;
box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
}
input:checked + .slider {
background-color: var(--win);
}
input:checked + .slider:before {
transform: translateX(76px);
}
.shop-grid {
display: grid;
grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
gap: 12px;
margin-top: 10px;
max-height: 300px;
overflow-y: auto;
padding-right: 5px;
scrollbar-width: thin;
scrollbar-color: var(--gold) var(--card);
}
.shop-grid::-webkit-scrollbar {
width: 6px;
}
.shop-grid::-webkit-scrollbar-track {
background: var(--card);
border-radius: 10px;
}
.shop-grid::-webkit-scrollbar-thumb {
background-color: var(--gold);
border-radius: 10px;
border: 1px solid var(--card);
}
.shop-item {
background: rgba(255, 255, 255, 0.06);
border: 1px solid rgba(255, 255, 255, 0.1);
border-radius: 20px;
padding: 12px;
text-align: center;
cursor: pointer;
transition: background 0.2s;
}
.shop-item:active {
transform: scale(0.95);
background: rgba(255, 255, 255, 0.1);
}
.shop-item.selected {
background: rgba(255, 204, 0, 0.15);
border-color: var(--gold);
}
.shop-item-icon {
width: 40px;
height: 40px;
margin: 0 auto 8px;
}
.shop-item-name {
font-size: 0.75rem;
font-weight: 700;
margin: 0 0 4px;
}
.shop-item-price {
font-size: 0.7rem;
opacity: 0.6;
}
.shop-detail-section {
background: rgba(255, 255, 255, 0.04);
border: 1px solid rgba(255, 255, 255, 0.05);
border-radius: 20px;
padding: 16px;
margin-top: 16px;
display: flex;
flex-direction: column;
align-items: center;
gap: 12px;
}
.shop-detail-icon-big {
width: 80px;
height: 80px;
object-fit: contain;
}
.shop-quantity-controls {
display: flex;
align-items: center;
gap: 10px;
width: 100%;
justify-content: center;
}
.qty-btn {
width: 36px;
height: 36px;
border-radius: 50%;
background: #252528;
border: 1px solid rgba(255, 255, 255, 0.08);
color: #fff;
font-size: 1.2rem;
display: flex;
align-items: center;
justify-content: center;
cursor: pointer;
transition: background 0.2s;
}
.qty-btn:active {
background: #333;
}
#qty-val {
font-size: 1.2rem;
font-weight: 700;
min-width: 30px;
text-align: center;
}
.shop-actions {
display: flex;
gap: 12px;
width: 100%;
margin-top: 10px;
}
.btn-trade {
background: var(--win);
color: #000;
border: none;
box-shadow: 0 4px 0 #2d9a4a;
}
.btn-trade.sell-mode {
background: var(--lose);
color: #fff;
box-shadow: 0 4px 0 #cc2e27;
}
.btn-nav-back {
background: #7f8c8d;
color: #fff;
border: none;
box-shadow: 0 4px 0 #566573;
}
.btn-nav-back:active {
background: #6c7b8b;
box-shadow: 0 1px 0 #566573;
}
.lb-values {
display: flex;
flex-direction: column;
align-items: flex-end;
gap: 2px;
}
.lb-value-row {
display: flex;
align-items: center;
gap: 4px;
font-weight: 900;
}
.lb-val-gold {
color: var(--gold);
}
.lb-val-acorn {
color: #a0522d;
}
@media (max-width: 360px) {
#profile-trigger, #rank-trigger {
width: 60px;
height: 60px;
right: 12px;
bottom: calc(16px + var(--safe-bottom));
}
.card {
padding: 24px 16px;
}
.menu-buttons {
max-width: 280px;
}
.res-title {
font-size: 1.8rem;
}
.res-icon {
font-size: 4rem;
}
}
</style>
</head>
<body>
<div id="bg-main" class="game-bg"></div>
<div id="bg-fight" class="game-bg"></div>
<div id="bg-inventory" class="game-bg"></div>
<div id="bg-shop" class="game-bg"></div>
<div class="bg-overlay"></div>
<div id="balance-header">
<span id="bal-val">0</span> üí∞
<span id="acorns-val">0</span> üå∞
<!-- --- –ê–ù–ò–ú–ê–¶–ò–Ø –°–ü–ò–°–ê–ù–ò–Ø (–í–´–õ–ï–¢ –ò–ó-–ü–û–î –ë–ê–õ–ê–ù–°–ê) --- -->
<div id="bet-deduction-notify">-0 üí∞</div>
<!-- --- –ö–û–ù–ï–¶ –ê–ù–ò–ú–ê–¶–ò–ò –°–ü–ò–°–ê–ù–ò–Ø --- -->
</div>
<div id="notification-toast" class="notification-toast">
–≠—Ç–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞–ø—Ä–µ—Ç–∏–ª –µ–º—É –ø–∏—Å–∞—Ç—å
</div>
<div id="rank-trigger" onclick="nav('scr-rank')">
<span>üèÜ</span>
</div>
<div id="profile-trigger" onclick="nav('scr-profile')">
<img src="assets/boar.png" onerror="this.src='https://api.dicebear.com/7.x/pixel-art/svg?seed=porker'">
</div>
<div id="scr-load" class="screen active">
<div style="width: 48px; height: 48px; border: 4px solid rgba(255,255,255,0.1); border-top-color: var(--gold); border-radius: 50%; animation: spin 0.8s cubic-bezier(0.5, 0, 0.5, 1) infinite;"></div>
</div>
<style>@keyframes spin {
to {
transform: rotate(360deg);
}
}</style>
<div id="result-overlay">
<div id="result-card">
<button class="close-x" onclick="closeResult()">&times;</button>
<span class="res-icon" id="res-icon">üèÜ</span>
<h2 class="res-title" id="res-title">–ü–û–ë–ï–î–ê</h2>
<div class="res-sum" id="res-sum">+500 üí∞</div>
<button class="res-btn" onclick="closeResult()">–ü–†–û–î–û–õ–ñ–ò–¢–¨</button>
</div>
</div>
<div id="user-modal" onclick="if(event.target==this) closeModal()">
<div class="card">
<button class="close-x" onclick="closeModal()" style="top:12px; right:12px;">&times;</button>
<h3 id="modal-user-name" style="margin-top:0; font-size: 1.5rem; padding-right: 30px;">–ò–ì–†–û–ö</h3>
<div class="stat-grid" style="margin-top: 20px;">
<div class="stat-item">
<span class="stat-val" id="modal-games">0</span>
<span class="stat-lbl">–ë–û–ï–í</span>
</div>
<div class="stat-item">
<span class="stat-val" id="modal-wins" style="color: var(--win);">0</span>
<span class="stat-lbl">–ü–û–ë–ï–î</span>
</div>
<div class="stat-item">
<span class="stat-val" id="modal-lose" style="color: var(--lose);">0</span>
<span class="stat-lbl">–ü–û–†–ê–ñ.</span>
</div>
<div class="stat-item">
<span class="stat-val" id="modal-winrate">0%</span>
<span class="stat-lbl">WINRATE</span>
</div>
</div>
<div class="stat-grid" style="margin-top: 15px;">
<div class="stat-item">
<span class="stat-val" id="modal-max-balance">0</span>
<span class="stat-lbl">–ú–ê–ö–°. –ë–ê–õ–ê–ù–°</span>
</div>
<div class="stat-item">
<span class="stat-val" id="modal-watched">0</span>
<span class="stat-lbl">–ü–†–û–°–ú–û–¢–†–ï–ù–û</span>
</div>
</div>
<button class="btn-wood" style="width: 100%; background: #0088cc; border:none; box-shadow: 0 4px 0 #006699;" id="modal-write-btn">–ù–ê–ü–ò–°–ê–¢–¨</button>
<button class="btn-wood" style="width: 100%; margin-top: 14px; opacity: 0.6;" onclick="closeModal()">–ó–ê–ö–†–´–¢–¨</button>
</div>
</div>
<div id="scr-main" class="screen">
<div class="menu-buttons">
<button class="btn-wood btn-play" onclick="nav('scr-bet')">–í –ë–û–ô</button>
<button class="btn-wood" onclick="nav('scr-inventory')">–ò–ù–í–ï–ù–¢–ê–†–¨</button>
<button class="btn-wood" onclick="nav('scr-shop')">–ú–ê–ì–ê–ó–ò–ù</button>
</div>
</div>
<div id="scr-bet" class="screen">
<div class="card">
<h3 style="margin-top:0; text-align: center; font-size: 1.4rem;">–í–ê–®–ê –°–¢–ê–í–ö–ê</h3>
<input type="number" id="bet-amt" value="100" min="10" inputmode="numeric">
<div style="display: flex; gap: 14px;">
<button class="btn-wood" style="flex:1; background: #3498db; border:none; box-shadow: 0 4px 0 #2573a7;" onclick="preStart(1)">–õ–ï–í–´–ô</button>
<button class="btn-wood" style="flex:1; background: #9b59b6; border:none; box-shadow: 0 4px 0 #7d4594;" onclick="preStart(2)">–ü–†–ê–í–´–ô</button>
</div>
<button class="btn-wood" style="background: #7f8c8d; border:none; box-shadow: 0 4px 0 #566573; margin: 8px auto; width: 80%; display: block;" onclick="watchBattle()">–ü–û–°–ú–û–¢–†–ï–¢–¨ –ë–û–ô (+1)</button>
<button class="btn-wood" style="margin-top: 8px; width: 100%; opacity: 0.6;" onclick="nav('scr-main')">–û–¢–ú–ï–ù–ê</button>
</div>
</div>
<div id="scr-inventory" class="screen">
<div class="card" style="text-align: center;">
<h2 style="margin-top:0;">–ò–ù–í–ï–ù–¢–ê–†–¨</h2>
<p style="opacity:0.5; font-size: 0.95rem;">–†–∞–∑–¥–µ–ª –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ</p>
<div style="font-size: 6rem; margin: 30px 0;">üéí</div>
<button class="btn-wood" style="width: 100%;" onclick="nav('scr-main')">–ù–ê–ó–ê–î</button>
</div>
</div>
<div id="scr-shop" class="screen">
<div class="card" style="max-height: 85vh; display: flex; flex-direction: column;">
<h3 style="margin-top:0; text-align: center;">–ú–ê–ì–ê–ó–ò–ù</h3>
<div class="shop-actions" style="margin-top: 10px; width: 100%; display: flex; align-items: center; justify-content: center; gap: 10px;">
<span class="label-left" style="font-size: 0.8rem; font-weight: 700; opacity: 0.7; color: #fff;">–ö–£–ü–ò–¢–¨</span>
<label class="toggle-switch" style="width: 120px; height: 40px; position: relative; display: inline-flex; align-items: center;">
<input type="checkbox" id="action-toggle" onchange="toggleAction()">
<span class="slider" style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: var(--lose); border-radius: 20px; cursor: pointer;"></span>
<span class="slider-thumb" style="position: absolute; top: 4px; left: 4px; width: 32px; height: 32px; background: #fff; border-radius: 50%; box-shadow: 0 4px 12px rgba(0,0,0,0.3); transition: transform 0.4s;"></span>
</label>
<span class="label-right" style="font-size: 0.8rem; font-weight: 700; opacity: 0.7; color: #fff;">–ü–†–û–î–ê–¢–¨</span>
</div>
<div id="shop-items-container" class="shop-grid" style="margin-top: 12px;"></div>
<div class="shop-detail-section">
<span id="detail-icon-placeholder" style="font-size: 4rem; opacity: 0.5;">üì¶</span>
<img id="detail-icon-big" class="shop-detail-icon-big" src="" alt="–ò–∫–æ–Ω–∫–∞ –ø—Ä–µ–¥–º–µ—Ç–∞" style="display: none;">
<div id="detail-name" style="font-size: 1.2rem; font-weight: 800;">–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–µ–¥–º–µ—Ç</div>
<div id="detail-price" style="font-size: 0.9rem; opacity: 0.7;">–¶–µ–Ω–∞: -</div>
<input type="number" id="qty-input" value="1" min="1" inputmode="numeric"
style="margin: 10px 0; width: 100%; padding: 16px; font-size: 1.4rem; text-align: center;
border-radius: 20px; background: rgba(255,255,255,0.06); border: 1px solid rgba(255,255,255,0.1);"
oninput="onQtyInput(this.value)">
<div id="total-cost" style="font-size: 1rem; font-weight: 700; color: var(--gold); text-align: center; margin-bottom: 12px; display: none;">
- üí∞ √ó - = - üí∞
</div>
<button class="btn-wood btn-trade" onclick="performTransaction()" style="width: 100%; margin-top: 10px;">–ö–£–ü–ò–¢–¨</button>
<button class="btn-wood btn-nav-back" onclick="nav('scr-main')">–ù–ê–ó–ê–î</button>
</div>
</div>
</div>
<div id="scr-profile" class="screen">
<div class="card">
<h3 style="margin-top:0;">–í–ê–® –•–†–Ø–ö</h3>
<input type="text" id="edit-name" placeholder="–ò–º—è —Ö—Ä—è–∫–∞">
<div class="stat-grid">
<div class="stat-item"><span class="stat-val" id="st-games">0</span><span class="stat-lbl">–ë–æ–µ–≤</span></div>
<div class="stat-item"><span class="stat-val" id="st-wins" style="color: var(--win);">0</span><span class="stat-lbl">–ü–æ–±–µ–¥</span></div>
<div class="stat-item"><span class="stat-val" id="st-lose" style="color: var(--lose);">0</span><span class="stat-lbl">–ü–æ—Ä–∞–∂.</span></div>
<div class="stat-item"><span class="stat-val" id="st-wr">0%</span><span class="stat-lbl">Winrate</span></div>
</div>
<div class="stat-grid">
<div class="stat-item"><span class="stat-val" id="st-max-balance">0</span><span class="stat-lbl">–ú–∞–∫—Å. –±–∞–ª–∞–Ω—Å</span></div>
<div class="stat-item"><span class="stat-val" id="st-watched">0</span><span class="stat-lbl">–ü—Ä–æ—Å–º–æ—Ç—Ä–µ–Ω–æ</span></div>
</div>
<div style="display: flex; align-items: center; justify-content: space-between; margin: 20px 0;">
<span>–ó–∞–ø—Ä–µ—Ç–∏—Ç—å –º–Ω–µ –ø–∏—Å–∞—Ç—å</span>
<label class="toggle-switch">
<input type="checkbox" id="private-profile-toggle" onchange="togglePrivateProfile()">
<span class="slider"></span>
</label>
</div>
<button class="btn-wood" style="width:100%; background: #fff; color: #000; box-shadow: 0 4px 0 #ccc;" onclick="updateName()">–°–û–•–†–ê–ù–ò–¢–¨</button>
<button class="btn-wood" style="width:100%; margin-top: 14px; opacity: 0.6;" onclick="nav('scr-main')">–ù–ê–ó–ê–î</button>
</div>
</div>
<div id="scr-rank" class="screen">
<div class="card" style="max-height: 85vh; display: flex; flex-direction: column;">
<h3 style="margin-top:0; text-align: center;">–¢–û–ü –ë–û–ô–¶–û–í</h3>
<div id="your-rank">–¢–≤–æ–µ –º–µ—Å—Ç–æ ‚Äî ?</div>
<div id="rank-loading" style="display: none; flex: 1; align-items: center; justify-content: center; flex-direction: column;">
<div style="width: 40px; height: 40px; border: 3px solid rgba(255,255,255,0.1); border-top-color: var(--gold); border-radius: 50%; animation: spin 0.8s cubic-bezier(0.5, 0, 0.5, 1) infinite; margin-bottom: 10px;"></div>
<span>–ó–∞–≥—Ä—É–∑–∫–∞...</span>
</div>
<div id="rank-list" style="overflow-y: auto; flex: 1; padding-right: 5px;"></div>
<button id="toggle-full-leaderboard" class="btn-wood" style="width:100%; margin-top: 10px; display: none;" onclick="toggleFullLeaderboard()">–†–∞–∑–≤–µ—Ä–Ω—É—Ç—å</button>
<button class="btn-wood" style="width:100%; margin-top: 10px;" onclick="nav('scr-main')">–ù–ê–ó–ê–î</button>
</div>
</div>
<div id="scr-fight" class="screen">
<div class="arena">
<div id="cont-1" class="boar-container">
<div class="hp-bar-box">
<div class="hp-txt" id="hp1-txt">100</div>
<div class="hp-bar"><div id="hp1-f" class="hp-fill"></div></div>
</div>
<div class="boar-unit">
<img id="boar1-img" src="assets/boar.png" onerror="this.src='https://api.dicebear.com/7.x/pixel-art/svg?seed=boar1'">
</div>
</div>
<div id="cont-2" class="boar-container">
<div class="hp-bar-box">
<div class="hp-txt" id="hp2-txt">100</div>
<div class="hp-bar"><div id="hp2-f" class="hp-fill"></div></div>
</div>
<div class="boar-unit">
<img id="boar2-img" src="assets/boar.png" onerror="this.src='https://api.dicebear.com/7.x/pixel-art/svg?seed=boar2'">
</div>
</div>
</div>
<div id="fight-log">–ü–û–î–ì–û–¢–û–í–ö–ê...</div>
</div>
<script>
const tg = window.Telegram.WebApp;
tg.expand();
let user = null;
let selectedSide = 0;
let isWatchingMode = false;
let fullLeaderboardLoaded = false;
let fullLeaderboardData = [];
let userRank = '?';
let currentShopItem = null;
let currentShopQuantity = 1;
let currentAction = 'buy';
let prices = {};
let isBattleLocked = false;
let battleResult = null;
let pendingBalance = null;

async function apiFetch(endpoint, options = {}) {
try {
const res = await fetch(endpoint, {
...options,
headers: {'Content-Type': 'application/json', ...(options.headers || {})}
});
return await res.json();
} catch (e) {
return null;
}
}

async function loadPrices() {
try {
const response = await fetch('prices.json');
if (!response.ok) {
throw new Error('Network response was not ok');
}
prices = await response.json();
console.log("–¶–µ–Ω—ã –∑–∞–≥—Ä—É–∂–µ–Ω—ã:", prices);
} catch (error) {
console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ prices.json:", error);
prices = {
"plant_acorn": {"buy": 1000, "sell": 800},
"acorn": {"buy": 200, "sell": 150}
};
}
}

async function auth() {
const tgUser = tg.initDataUnsafe?.user || {id: "dev_user", username: "kaban", first_name: "–•—Ä—è–∫"};
user = await apiFetch('/api/auth', {
method: 'POST',
body: JSON.stringify({tg_id: tgUser.id, username: tgUser.username, first_name: tgUser.first_name})
});
if (user) {
updateUI();
nav('scr-main');
} else {
console.error("–ù–µ —É–¥–∞–ª–æ—Å—å –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞—Ç—å—Å—è");
showToast("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–æ—Ñ–∏–ª—è");
}
}

function updateUI() {
if (!user) return;
document.getElementById('bal-val').innerText = user.balance.toLocaleString();
document.getElementById('acorns-val').innerText = user.acorns.toLocaleString();
document.getElementById('edit-name').value = user.display_name || user.username || "";
document.getElementById('st-games').innerText = user.total_games || 0;
document.getElementById('st-wins').innerText = user.wins || 0;
document.getElementById('st-lose').innerText = user.lose || 0;
const wr = user.total_games > 0 ? Math.round((user.wins / user.total_games) * 100) : 0;
document.getElementById('st-wr').innerText = wr + "%";
document.getElementById('st-max-balance').innerText = (user.max_balance || 0).toLocaleString();
document.getElementById('st-watched').innerText = user.watched_battles || 0;
const toggle = document.getElementById('private-profile-toggle');
if (toggle) toggle.checked = !!user.private_profile;
}

function nav(id) {
document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
document.getElementById(id).classList.add('active');
document.getElementById('bg-main').style.display = 'block';
document.getElementById('bg-fight').style.display = 'none';
document.getElementById('bg-inventory').style.display = 'none';
document.getElementById('bg-shop').style.display = 'none';
if (id === 'scr-fight') {
document.getElementById('bg-main').style.display = 'none';
document.getElementById('bg-fight').style.display = 'block';
} else if (id === 'scr-inventory') {
document.getElementById('bg-main').style.display = 'none';
document.getElementById('bg-inventory').style.display = 'block';
} else if (id === 'scr-shop') {
document.getElementById('bg-main').style.display = 'none';
document.getElementById('bg-shop').style.display = 'block';
resetShopState();
loadShopItems();
}
const isCardScreen = ['scr-bet', 'scr-inventory', 'scr-shop', 'scr-profile', 'scr-rank', 'scr-load'].includes(id);
document.body.classList.toggle('dimmed', isCardScreen);
document.body.classList.toggle('show-main-screen', id === 'scr-main');
if (id === 'scr-main') {
document.body.classList.add('show-profile-btn');
} else {
document.body.classList.remove('show-profile-btn');
}
if (id === 'scr-rank') loadRank();
tg.HapticFeedback.impactOccurred('light');
}

function resetShopState() {
currentShopItem = null;
currentShopQuantity = 1;
document.getElementById('qty-input').value = '1';
document.getElementById('detail-icon-placeholder').style.display = 'block';
document.getElementById('detail-icon-big').style.display = 'none';
document.getElementById('detail-name').innerText = '–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–µ–¥–º–µ—Ç';
document.getElementById('detail-price').innerText = '–¶–µ–Ω–∞: -';
document.getElementById('total-cost').style.display = 'none';
document.querySelectorAll('#shop-items-container .shop-item').forEach(el => el.classList.remove('selected'));
const toggle = document.getElementById('action-toggle');
toggle.checked = false;
currentAction = 'buy';
document.querySelector('.slider').style.backgroundColor = 'var(--win)';
document.querySelector('.slider-thumb').style.transform = 'translateX(0)';
updateTradeButton();
updatePriceDisplay();
}

async function loadShopItems() {
await loadPrices();
const container = document.getElementById('shop-items-container');
container.innerHTML = "";
const itemIds = ["acorn", "plant_acorn"];
for (const itemId of itemIds) {
const item = {
id: itemId,
name: itemId === "acorn" ? "–ñ–µ–ª—É–¥—å" : "–†–æ—Å—Ç–æ–∫",
icon: itemId === "acorn" ? "acorn.png" : "plant_acorn.png",
price: prices[itemId]?.buy || 0,
sell_price: prices[itemId]?.sell || 0
};
const div = document.createElement('div');
div.className = 'shop-item';
div.onclick = () => selectShopItem(item);
div.innerHTML = `
<img class="shop-item-icon" src="assets/${item.icon}" onerror="this.src='https://placehold.co/40x40?text=?'">
<div class="shop-item-name">${item.name}</div>
<div class="shop-item-price">${currentAction === 'buy' ? item.price : item.sell_price} üí∞</div>
`;
container.appendChild(div);
}
}

function selectShopItem(item) {
currentShopItem = item;
currentShopQuantity = 1;
document.getElementById('qty-input').value = currentShopQuantity;
document.getElementById('detail-icon-placeholder').style.display = 'none';
document.getElementById('detail-icon-big').src = `assets/${item.icon}`;
document.getElementById('detail-icon-big').style.display = 'block';
document.getElementById('detail-name').innerText = item.name;
updatePriceDisplay();
document.querySelectorAll('#shop-items-container .shop-item').forEach(el => el.classList.remove('selected'));
event.currentTarget.classList.add('selected');
}

function toggleAction() {
const checkbox = document.getElementById('action-toggle');
const thumb = document.querySelector('#scr-shop .slider-thumb');
currentAction = checkbox.checked ? 'sell' : 'buy';
updatePriceDisplay();
updateShopItemPrices();
updateTradeButton();
if (thumb) {
thumb.style.transform = checkbox.checked ? 'translateX(76px)' : 'translateX(0)';
}
const slider = document.querySelector('.slider');
slider.style.backgroundColor = currentAction === 'buy' ? 'var(--win)' : 'var(--lose)';
}

function updateTradeButton() {
const button = document.querySelector('#scr-shop .btn-trade');
button.innerText = currentAction === 'buy' ? '–ö–£–ü–ò–¢–¨' : '–ü–†–û–î–ê–¢–¨';
button.classList.toggle('sell-mode', currentAction === 'sell');
}

function updateShopItemPrices() {
const items = document.querySelectorAll('#shop-items-container .shop-item');
items.forEach((el, index) => {
const itemIds = ["acorn", "plant_acorn"];
const itemId = itemIds[index];
const item = {
id: itemId,
name: itemId === "acorn" ? "–ñ–µ–ª—É–¥—å" : "–†–æ—Å—Ç–æ–∫",
icon: itemId === "acorn" ? "acorn.png" : "plant_acorn.png",
price: prices[itemId]?.buy || 0,
sell_price: prices[itemId]?.sell || 0
};
el.querySelector('.shop-item-price').innerText = `${currentAction === 'buy' ? item.price : item.sell_price} üí∞`;
});
}

function updatePriceDisplay() {
const totalCostEl = document.getElementById('total-cost');
if (!currentShopItem) {
document.getElementById('detail-price').innerText = '–¶–µ–Ω–∞: -';
totalCostEl.style.display = 'none';
return;
}
const price = currentAction === 'buy' ? currentShopItem.price : currentShopItem.sell_price;
const total = price * currentShopQuantity;
document.getElementById('detail-price').innerText = `–¶–µ–Ω–∞: ${price} üí∞ / —à—Ç.`;
totalCostEl.innerHTML = `${price} üí∞ √ó ${currentShopQuantity} = ${total} üí∞`;
totalCostEl.style.display = 'block';
}

function onQtyInput(value) {
let newQty = parseInt(value) || 1;
if (newQty < 1) newQty = 1;
if (newQty > 999999) newQty = 999999;
currentShopQuantity = newQty;
updatePriceDisplay();
}

async function performTransaction() {
if (!currentShopItem) {
tg.HapticFeedback.notificationOccurred('error');
showToast("–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–µ–¥–º–µ—Ç");
return;
}
const endpoint = currentAction === 'buy' ? '/api/shop/buy' : '/api/shop/sell';
const payload = {
tg_id: user.tg_id,
item_id: currentShopItem.id,
quantity: currentShopQuantity
};
const response = await apiFetch(endpoint, {
method: 'POST',
body: JSON.stringify(payload)
});
if (response && response.success) {
user.balance = response.new_balance;
user.acorns = response.new_acorns;
user.plant_acorns = response.new_plant_acorns;
updateUI();
tg.HapticFeedback.notificationOccurred('success');
showToast(`${currentAction === 'buy' ? '–ö—É–ø–ª–µ–Ω–æ' : '–ü—Ä–æ–¥–∞–Ω–æ'} ${currentShopQuantity}x ${currentShopItem.name}`);
} else {
tg.HapticFeedback.notificationOccurred('error');
showToast(response?.error || "–û—à–∏–±–∫–∞ –æ–ø–µ—Ä–∞—Ü–∏–∏");
}
}

function findUserRank(data) {
for (let i = 0; i < data.length; i++) {
if (data[i].tg_id === user.tg_id) {
return i + 1;
}
}
return '?';
}

function calculateProgress(userBalance, maxBalance) {
if (maxBalance <= 0) return 0;
return Math.min(100, (userBalance / maxBalance) * 100);
}

async function loadRank() {
fullLeaderboardLoaded = false;
fullLeaderboardData = [];
document.getElementById('toggle-full-leaderboard').style.display = 'none';
document.getElementById('your-rank').textContent = '–¢–≤–æ–µ –º–µ—Å—Ç–æ ‚Äî ?';
document.getElementById('rank-loading').style.display = 'flex';
document.getElementById('rank-list').style.display = 'none';
const data = await apiFetch('/api/leaderboard');
const list = document.getElementById('rank-list');
list.innerHTML = "";
if (!data || !Array.isArray(data)) {
document.getElementById('your-rank').textContent = '–¢–≤–æ–µ –º–µ—Å—Ç–æ ‚Äî ?';
document.getElementById('rank-loading').style.display = 'none';
document.getElementById('rank-list').style.display = 'block';
return;
}
let userIndex = -1;
for (let i = 0; i < data.length; i++) {
if (data[i].tg_id === user?.tg_id) {
userIndex = i;
break;
}
}
if (userIndex !== -1) {
userRank = userIndex + 1;
} else {
if (data.your_rank !== undefined && data.your_rank > 0) {
userRank = data.your_rank;
} else {
userRank = data.length + 1;
}
}
document.getElementById('your-rank').textContent = `–¢–≤–æ–µ –º–µ—Å—Ç–æ ‚Äî ${userRank}`;
const maxBalance = data.length > 0 ? data[0].balance : 0;
data.forEach((u, i) => {
const item = document.createElement('div');
item.className = 'rank-item';
if (user && u.tg_id === user.tg_id) {
item.classList.add('current-user-highlight');
}
item.innerHTML = `
<div style="display:flex; align-items:center; gap:12px;">
<span style="opacity:0.3; font-weight:900; width:24px; font-size: 0.8rem;">${i+1}</span>
<span style="font-weight:700;">${u.display_name || u.username}</span>
</div>
<div class="lb-values">
<div class="lb-value-row">
<span class="lb-val-gold">${u.balance.toLocaleString()} üí∞</span>
</div>
<div class="lb-value-row">
<span class="lb-val-acorn">${u.acorns ? u.acorns.toLocaleString() : '0'} üå∞</span>
</div>
</div>
`;
item.onclick = () => showUserDetail(u);
list.appendChild(item);
});
document.getElementById('rank-loading').style.display = 'none';
document.getElementById('rank-list').style.display = 'block';
document.getElementById('toggle-full-leaderboard').style.display = 'block';
document.getElementById('toggle-full-leaderboard').textContent = '–†–∞–∑–≤–µ—Ä–Ω—É—Ç—å';
}

async function toggleFullLeaderboard() {
const button = document.getElementById('toggle-full-leaderboard');
const list = document.getElementById('rank-list');
if (!fullLeaderboardLoaded) {
button.textContent = '–ó–∞–≥—Ä—É–∑–∫–∞...';
button.disabled = true;
const data = await apiFetch('/api/leaderboard/full');
if (data) {
fullLeaderboardData = data;
fullLeaderboardLoaded = true;
userRank = findUserRank(data);
document.getElementById('your-rank').textContent = `–¢–≤–æ–µ –º–µ—Å—Ç–æ ‚Äî ${userRank}`;
const maxBalance = data.length > 0 ? data[0].balance : 0;
renderLeaderboard(fullLeaderboardData, true, maxBalance);
button.textContent = '–°–≤–µ—Ä–Ω—É—Ç—å';
} else {
button.textContent = '–û—à–∏–±–∫–∞';
setTimeout(() => button.textContent = '–†–∞–∑–≤–µ—Ä–Ω—É—Ç—å', 2000);
}
button.disabled = false;
} else {
fullLeaderboardLoaded = false;
loadRank();
}
}

function renderLeaderboard(data, isFullList = false, maxBalanceOverride = null) {
const list = document.getElementById('rank-list');
list.innerHTML = "";
const maxBalance = maxBalanceOverride || (data.length > 0 ? data[0].balance : 0);
data.forEach((u, i) => {
const item = document.createElement('div');
item.className = 'rank-item';
if (user && u.tg_id === user.tg_id) {
item.classList.add('current-user-highlight');
}
const progress = calculateProgress(u.balance, maxBalance);
item.innerHTML = `
<div style="display:flex; align-items:center; gap:12px;">
<span style="opacity:0.3; font-weight:900; width:24px; font-size: 0.8rem;">${i+1}</span>
<span style="font-weight:700;">${u.display_name || u.username}</span>
</div>
<div class="lb-values">
<div class="lb-value-row">
<span class="lb-val-gold">${u.balance.toLocaleString()} üí∞</span>
</div>
<div class="lb-value-row">
<span class="lb-val-acorn">${u.acorns ? u.acorns.toLocaleString() : '0'} üå∞</span>
</div>
</div>
`;
item.onclick = () => showUserDetail(u);
list.appendChild(item);
});
}

function showUserDetail(u) {
tg.HapticFeedback.selectionChanged();
document.getElementById('modal-user-name').innerText = u.display_name || u.username;
document.getElementById('modal-games').innerText = u.total_games || 0;
document.getElementById('modal-wins').innerText = u.wins || 0;
document.getElementById('modal-lose').innerText = u.lose || 0;
const wr = u.total_games > 0 ? Math.round((u.wins / u.total_games) * 100) : 0;
document.getElementById('modal-winrate').innerText = wr + "%";
document.getElementById('modal-max-balance').innerText = (u.max_balance || 0).toLocaleString();
document.getElementById('modal-watched').innerText = (u.watched_battles || 0).toLocaleString();
const btn = document.getElementById('modal-write-btn');
if (u.username) {
btn.style.display = 'block';
btn.textContent = '–ù–ê–ü–ò–°–ê–¢–¨';
if (u.private_profile) {
btn.style.background = '#7f8c8d';
btn.style.boxShadow = '0 4px 0 #566573';
btn.onclick = () => {
showToast("–≠—Ç–æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞–ø—Ä–µ—Ç–∏–ª –µ–º—É –ø–∏—Å–∞—Ç—å");
tg.HapticFeedback.notificationOccurred('error');
};
} else {
btn.style.background = '#0088cc';
btn.style.boxShadow = '0 4px 0 #006699';
btn.onclick = () => tg.openTelegramLink(`https://t.me/${u.username}`);
}
} else {
btn.style.display = 'none';
btn.onclick = null;
}
document.getElementById('user-modal').style.display = 'flex';
}

function closeModal() {
document.getElementById('user-modal').style.display = 'none';
}

async function togglePrivateProfile() {
const toggle = document.getElementById('private-profile-toggle');
const isChecked = toggle.checked;
const response = await apiFetch('/api/user/set-private', {
method: 'POST',
body: JSON.stringify({tg_id: user.tg_id, is_private: isChecked})
});
if (response && response.success) {
user.private_profile = isChecked;
console.log("–ü—Ä–æ—Ñ–∏–ª—å —Å—Ç–∞–ª", isChecked ? "–ø—Ä–∏–≤–∞—Ç–Ω—ã–º." : "–ø—É–±–ª–∏—á–Ω—ã–º.");
} else {
console.error("–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞ –ø—Ä–∏–≤–∞—Ç–Ω–æ—Å—Ç–∏:", response?.error || "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞");
toggle.checked = !isChecked;
}
}

function showToast(message) {
const toast = document.getElementById('notification-toast');
toast.textContent = message;
toast.classList.add('show');
setTimeout(() => toast.classList.remove('show'), 2500);
}

// === –ê–ù–ò–ú–ê–¶–ò–Ø –°–ü–ò–°–ê–ù–ò–Ø (–í–´–õ–ï–¢ –ò–ó-–ü–û–î –ë–ê–õ–ê–ù–°–ê) ===
function showBetDeduction(amount) {
const notify = document.getElementById('bet-deduction-notify');
notify.innerText = `-${amount} üí∞`;
notify.classList.add('show');
setTimeout(() => {
notify.classList.remove('show');
}, 2000);
}
// === –ö–û–ù–ï–¶ –ê–ù–ò–ú–ê–¶–ò–ò –°–ü–ò–°–ê–ù–ò–Ø ===

async function watchBattle() {
if (document.getElementById('scr-fight').classList.contains('active')) return;
isWatchingMode = true;
startBattle(0);
}

async function updateName() {
const name = document.getElementById('edit-name').value;
if (!name) return;
await apiFetch('/api/user/update-name', {
method: 'POST',
body: JSON.stringify({tg_id: user.tg_id, display_name: name})
});
user.display_name = name;
tg.HapticFeedback.notificationOccurred('success');
nav('scr-main');
}

// === –†–ï–§–ê–ö–¢–û–†–ò–ù–ì –ú–ï–•–ê–ù–ò–ö–ò –ë–û–Ø ===

async function preStart(side) {
if (isBattleLocked) return;

const input = document.getElementById('bet-amt');
const amt = parseInt(input.value);

if (isNaN(amt) || amt < 10) {
tg.HapticFeedback.notificationOccurred('error');
showToast("–ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —Å—Ç–∞–≤–∫–∞: 10 üí∞");
return;
}

if (amt > user.balance) {
tg.HapticFeedback.notificationOccurred('error');
showToast("–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –∑–æ–ª–æ—Ç–∞");
return;
}

// 1. –ú–ì–ù–û–í–ï–ù–ù–û–ï –°–ü–ò–°–ê–ù–ò–ï: –æ–±–Ω–æ–≤–ª—è–µ–º –±–∞–ª–∞–Ω—Å –≤–∏–∑—É–∞–ª—å–Ω–æ
const newTempBalance = user.balance - amt;
document.getElementById('bal-val').innerText = newTempBalance.toLocaleString();

// 2. –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∞–Ω–∏–º–∞—Ü–∏—é –≤—ã–ª–µ—Ç–∞—é—â–µ–≥–æ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
showBetDeduction(amt);

// –ë–ª–æ–∫–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É –∏ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
isBattleLocked = true;
input.disabled = true;
selectedSide = side;
isWatchingMode = false;

try {
// 3. –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å –Ω–∞ —Å–µ—Ä–≤–µ—Ä –ü–ï–†–ï–î –Ω–∞—á–∞–ª–æ–º –∞–Ω–∏–º–∞—Ü–∏–∏
const response = await apiFetch('/api/battle/init', {
method: 'POST',
body: JSON.stringify({
tg_id: user.tg_id,
bet_amount: amt
})
});

if (!response || response.error) {
throw new Error(response?.error || '–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –±–æ—è');
}

// 4. –°–æ—Ö—Ä–∞–Ω—è–µ–º new_balance –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é, –ù–ï –æ–±–Ω–æ–≤–ª—è–µ–º UI –µ—â—ë
battleResult = response;
pendingBalance = response.new_balance;

// 5. –ó–∞–ø—É—Å–∫–∞–µ–º –∞–Ω–∏–º–∞—Ü–∏—é –±–æ—è —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ –æ—Ç–≤–µ—Ç–∞
startBattle(amt, response);

} catch (error) {
console.error("–û—à–∏–±–∫–∞ –Ω–∞—á–∞–ª–∞ –±–æ—è:", error);
tg.HapticFeedback.notificationOccurred('error');
showToast(error.message || "–û—à–∏–±–∫–∞ –Ω–∞—á–∞–ª–∞ –±–æ—è");
isBattleLocked = false;
input.disabled = false;
// –í–æ–∑–≤—Ä–∞—â–∞–µ–º –±–∞–ª–∞–Ω—Å –æ–±—Ä–∞—Ç–Ω–æ –ø—Ä–∏ –æ—à–∏–±–∫–µ
document.getElementById('bal-val').innerText = user.balance.toLocaleString();
}
}

function spawnDmg(container, val) {
const p = document.createElement('div');
p.className = 'dmg-popup';
p.innerText = `-${val}`;
p.style.left = Math.random() * 40 + 30 + "%";
container.appendChild(p);
setTimeout(() => p.remove(), 700);
}

// === –ì–ï–ù–ï–†–ê–¶–ò–Ø –£–î–ê–†–û–í –° –ü–†–û–í–ï–†–ö–û–ô –ü–û–ë–ï–î–ò–¢–ï–õ–Ø ===
function generateHits(serverResult) {
const playerSide = selectedSide;
const opponentSide = selectedSide === 1 ? 2 : 1;
const playerWins = serverResult?.is_win === true;
const winningSide = playerWins ? playerSide : opponentSide;

let hits = [];
let attempts = 0;
const maxAttempts = 50;

// –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —É–¥–∞—Ä—ã –ø–æ–∫–∞ –≤–∏–∑—É–∞–ª—å–Ω—ã–π –ø–æ–±–µ–¥–∏—Ç–µ–ª—å –Ω–µ —Å–æ–≤–ø–∞–¥–µ—Ç —Å —Å–µ—Ä–≤–µ—Ä–Ω—ã–º
while (attempts < maxAttempts) {
hits = [];
let tempHP1 = 100;
let tempHP2 = 100;
let currentTarget = 1; // –ù–∞—á–∏–Ω–∞–µ–º —Å –ª–µ–≤–æ–≥–æ –∫–∞–±–∞–Ω–∞

// –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —É–¥–∞—Ä—ã –ø–æ –æ—á–µ—Ä–µ–¥–∏ –ø–æ–∫–∞ –∫—Ç–æ-—Ç–æ –Ω–µ —É–º—Ä–µ—Ç
while (tempHP1 > 0 && tempHP2 > 0) {
// –£—Ä–æ–Ω —Å—Ç—Ä–æ–≥–æ 5-20 HP
const dmg = Math.floor(Math.random() * 16) + 5;

if (currentTarget === 1) {
tempHP1 = Math.max(0, tempHP1 - dmg);
hits.push({ target: 1, dmg, isFinal: tempHP1 <= 0 });
if (tempHP1 <= 0) break;
currentTarget = 2;
} else {
tempHP2 = Math.max(0, tempHP2 - dmg);
hits.push({ target: 2, dmg, isFinal: tempHP2 <= 0 });
if (tempHP2 <= 0) break;
currentTarget = 1;
}
}

// –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Å–æ–≤–ø–∞–¥–∞–µ—Ç –ª–∏ –≤–∏–∑—É–∞–ª—å–Ω—ã–π –ø–æ–±–µ–¥–∏—Ç–µ–ª—å —Å —Å–µ—Ä–≤–µ—Ä–Ω—ã–º
const visualWinner = tempHP1 > 0 ? 1 : 2;
if (visualWinner === winningSide) {
break; // –ü–æ–±–µ–¥–∏—Ç–µ–ª—å —Å–æ–≤–ø–∞–ª, –≤—ã—Ö–æ–¥–∏–º –∏–∑ —Ü–∏–∫–ª–∞
}

attempts++;
}

return hits;
}
// === –ö–û–ù–ï–¶ –ì–ï–ù–ï–†–ê–¶–ò–ò –£–î–ê–†–û–í ===

function startBattle(bet, serverResult) {
nav('scr-fight');

let h1 = 100, h2 = 100;
const log = document.getElementById('fight-log');

// 1. –°—Ä–∞–∑—É: "–ü–û–î–ì–û–¢–û–í–ö–ê –ö –ë–û–Æ..."
log.innerText = "–ü–û–î–ì–û–¢–û–í–ö–ê –ö –ë–û–Æ...";

document.getElementById('hp1-f').style.width = "100%";
document.getElementById('hp2-f').style.width = "100%";
document.getElementById('hp1-txt').innerText = "100";
document.getElementById('hp2-txt').innerText = "100";

// –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —É–¥–∞—Ä—ã —Å –ø—Ä–æ–≤–µ—Ä–∫–æ–π –ø–æ–±–µ–¥–∏—Ç–µ–ª—è
const hits = generateHits(serverResult);

const playerSide = selectedSide;
const playerWins = serverResult?.is_win === true;

let hitIndex = 0;
let battleEnded = false;

// 2. –í –º–æ–º–µ–Ω—Ç –Ω–∞—á–∞–ª–∞ –∞–Ω–∏–º–∞—Ü–∏–∏: "–ò–î–ï–¢ –ë–û–ô..."
setTimeout(() => {
if (!battleEnded) {
log.innerText = "–ò–î–ï–¢ –ë–û–ô...";
}
}, 500);

const interval = setInterval(() => {
// === –ü–†–û–í–ï–†–ö–ê: –µ—Å–ª–∏ –±–æ–π —É–∂–µ –∑–∞–∫–æ–Ω—á–µ–Ω –∏–ª–∏ —É–¥–∞—Ä—ã –∫–æ–Ω—á–∏–ª–∏—Å—å ===
if (hitIndex >= hits.length || battleEnded) {
clearInterval(interval);
return;
}

const hit = hits[hitIndex];
const cont = document.getElementById(`cont-${hit.target}`);
cont.classList.add('hit');
spawnDmg(cont, hit.dmg);
setTimeout(() => cont.classList.remove('hit'), 250);

if (hit.target === 1) {
h1 = Math.max(0, h1 - hit.dmg);
document.getElementById('hp1-f').style.width = h1 + "%";
document.getElementById('hp1-txt').innerText = h1;
} else {
h2 = Math.max(0, h2 - hit.dmg);
document.getElementById('hp2-f').style.width = h2 + "%";
document.getElementById('hp2-txt').innerText = h2;
}

tg.HapticFeedback.impactOccurred('medium');

// 3. === –ú–ì–ù–û–í–ï–ù–ù–ê–Ø –ü–†–û–í–ï–†–ö–ê: –µ—Å–ª–∏ HP –¥–æ—Å—Ç–∏–≥–ª–æ 0 ===
if (h1 <= 0 || h2 <= 0) {
battleEnded = true;
clearInterval(interval); // –ù–µ–º–µ–¥–ª–µ–Ω–Ω–æ –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∏–Ω—Ç–µ—Ä–≤–∞–ª

// 4. –°—Ä–∞–∑—É –ø–∏—à–µ–º –ø–æ–±–µ–¥–∏—Ç–µ–ª—è –≤ –ª–æ–≥
const winnerName = h1 > 0 ? "–õ–ï–í–´–ô" : "–ü–†–ê–í–´–ô";
log.innerText = `–ü–û–ë–ï–î–ò–õ –ö–ê–ë–ê–ù ${winnerName}`;

// –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç —á–µ—Ä–µ–∑ –Ω–µ–±–æ–ª—å—à—É—é –∑–∞–¥–µ—Ä–∂–∫—É
setTimeout(() => {
tg.HapticFeedback.notificationOccurred(playerWins ? 'success' : 'error');

const isWin = playerWins;

if (isWin) {
// –ü—Ä–∏ –ø–æ–±–µ–¥–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—ã–∏–≥—Ä—ã—à (—Å—Ç–∞–≤–∫–∞ * 2)
showResult("–ü–û–ë–ï–î–ê", `–í–´–ò–ì–†–´–®: ${bet} üí∞`, true);
} else {
// –ü—Ä–∏ –ø–æ—Ä–∞–∂–µ–Ω–∏–∏ –Ω–µ –ø–∏—à–µ–º –ø—Ä–æ –º–∏–Ω—É—Å (—É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –±—ã–ª–æ –≤ –Ω–∞—á–∞–ª–µ)
showResult("–ü–û–†–ê–ñ–ï–ù–ò–ï", "", false);
}

isBattleLocked = false;
document.getElementById('bet-amt').disabled = false;
}, 1000);
return;
}

hitIndex++;
}, 700);
}

function showResult(title, sum, isWin) {
const overlay = document.getElementById('result-overlay');
const card = document.getElementById('result-card');
const t = document.getElementById('res-title');
const s = document.getElementById('res-sum');
const icon = document.getElementById('res-icon');
t.innerText = title;
s.innerText = sum;
icon.innerText = isWin ? "üèÜ" : "üíÄ";
overlay.style.display = 'flex';
setTimeout(() => card.classList.add('active'), 50);
}

function closeResult() {
// === –û–ë–ù–û–í–õ–ï–ù–ò–ï –ë–ê–õ–ê–ù–°–ê –¢–û–õ–¨–ö–û –ó–î–ï–°–¨ (–∫–æ–≥–¥–∞ –∏–≥—Ä–æ–∫ –∂–º–µ—Ç "–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å") ===
if (pendingBalance !== null && !isWatchingMode) {
user.balance = pendingBalance;
if (battleResult?.acorns !== undefined) user.acorns = battleResult.acorns;
if (battleResult?.plant_acorns !== undefined) user.plant_acorns = battleResult.plant_acorns;
if (battleResult?.max_balance !== undefined) user.max_balance = battleResult.max_balance;
if (battleResult?.watched_battles !== undefined) user.watched_battles = battleResult.watched_battles;

// –û–±–Ω–æ–≤–ª—è–µ–º UI —Å –±–∞–ª–∞–Ω—Å–æ–º
document.getElementById('bal-val').innerText = user.balance.toLocaleString();
document.getElementById('acorns-val').innerText = user.acorns.toLocaleString();

// –°–±—Ä–∞—Å—ã–≤–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
pendingBalance = null;
battleResult = null;
}
// === –ö–û–ù–ï–¶ –û–ë–ù–û–í–õ–ï–ù–ò–Ø –ë–ê–õ–ê–ù–°–ê ===

const card = document.getElementById('result-card');
card.classList.remove('active');
setTimeout(() => {
document.getElementById('result-overlay').style.display = 'none';
if (!isWatchingMode) {
nav('scr-main');
} else {
nav('scr-main');
}
}, 300);
}

auth();
</script>
</body>
</html>