<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport"
content="width=device-width, initial-scale=1.0, viewport-fit=cover, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="theme-color" content="#0a0a0c">
<meta name="mobile-web-app-capable" content="yes">
<title>WILD TUSK BRAWL</title>
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<style>
:root {
--bg: #0a0a0c;
--accent: #ff3e3e;
--gold: #ffcc00;
--text: #ffffff;
--card: rgba(18, 18, 20, 0.95);
--radius: 28px;
--win: #4cd964;
--lose: #ff3e3e;
--transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
--safe-top: env(safe-area-inset-top, 20px);
--safe-bottom: env(safe-area-inset-bottom, 34px);
--safe-left: env(safe-area-inset-left, 0px);
--safe-right: env(safe-area-inset-right, 0px);
}
body {
margin: 0;
font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
background: var(--bg);
color: var(--text);
overflow: hidden;
-webkit-font-smoothing: antialiased;
touch-action: manipulation;
padding-bottom: 0;
height: 100dvh;
width: 100vw;
}
/* –§–æ–Ω–æ–≤—ã–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è */
.game-bg {
position: fixed;
top: 0;
left: 0;
width: 100%;
height: 100%;
background-size: cover;
background-position: center;
z-index: -2;
transition: filter 0.5s ease, transform 0.5s ease;
}
#bg-main {
background-image: url('assets/main_menu.png');
background-color: #1a1a1a;
}
#bg-fight {
background-image: url('assets/fight_field.png');
background-color: #000;
display: none;
}
#bg-inventory {
background-image: url('assets/inventory.png');
background-color: #0a0a0c;
display: none;
}
#bg-shop {
background-image: url('assets/shop.png');
background-color: #0a0a0c;
display: none;
}
.bg-overlay {
position: fixed;
top: 0;
left: 0;
width: 100%;
height: 100%;
background: rgba(0, 0, 0, 0.75);
z-index: -1;
opacity: 0;
transition: opacity 0.4s ease;
pointer-events: none;
backdrop-filter: blur(0px);
}
body.dimmed .bg-overlay {
opacity: 1;
backdrop-filter: blur(8px);
pointer-events: auto;
}
body.dimmed .game-bg {
filter: brightness(0.5);
transform: scale(1.05);
}
.screen {
display: none;
width: 100%;
height: 100%;
flex-direction: column;
align-items: center;
justify-content: center;
padding: 24px;
padding-top: calc(20px + var(--safe-top));
padding-bottom: calc(20px + var(--safe-bottom));
box-sizing: border-box;
position: absolute;
top: 0;
left: 0;
overflow-y: auto;
}
.active {
display: flex;
animation: screenIn 0.4s forwards;
}
@keyframes screenIn {
from {
opacity: 0;
transform: translateY(10px);
}
to {
opacity: 1;
transform: translateY(0);
}
}
#balance-header {
position: fixed;
top: calc(12px + var(--safe-top));
left: calc(16px + var(--safe-left));
background: rgba(0, 0, 0, 0.6);
backdrop-filter: blur(15px);
border: 1px solid rgba(255, 255, 255, 0.1);
padding: 10px 20px;
border-radius: 100px;
font-weight: 800;
color: var(--gold);
z-index: 1000;
display: flex;
align-items: center;
gap: 8px;
box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
}
/* --- –ò–ó–ú–ï–ù–Å–ù–ù–´–ô –°–¢–ò–õ–¨: –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ --- */
.notification-toast {
position: fixed;
top: calc(12px + var(--safe-top));
left: 50%;
transform: translateX(-50%);
background: rgba(0, 0, 0, 0.85);
backdrop-filter: blur(15px);
border: 1px solid rgba(255, 255, 255, 0.15);
padding: 12px 24px;
border-radius: 20px;
color: white;
font-weight: 700;
font-size: 0.9rem;
z-index: 6000;
opacity: 0;
visibility: hidden;
transition: opacity 0.3s ease, visibility 0.3s ease, transform 0.3s ease;
box-shadow: 0 4px 20px rgba(0, 0, 0, 0.4);
text-align: center;
max-width: 80%;
width: fit-content;
}
.notification-toast.show {
opacity: 1;
visibility: visible;
transform: translateX(-50%) translateY(40px);
}
/* --- –ö–û–ù–ï–¶ –ò–ó–ú–ï–ù–Å–ù–ù–û–ì–û –°–¢–ò–õ–Ø --- */
/* --- –ù–û–í–ê–Ø –°–¢–ò–õ–ò–ó–ê–¶–ò–Ø –î–õ–Ø –ö–ù–û–ü–û–ö --- */
#rank-trigger,
#profile-trigger {
position: fixed;
bottom: calc(20px + var(--safe-bottom));
width: 68px;
height: 68px;
background: rgba(30, 30, 34, 0.92);
border: 1px solid rgba(255, 255, 255, 0.14);
border-radius: 50%;
display: flex;
align-items: center;
justify-content: center;
cursor: pointer;
z-index: 3000;
box-shadow: 0 10px 30px rgba(0, 0, 0, 0.6);
backdrop-filter: blur(10px);
transition: transform 0.2s, opacity 0.2s;
}
#rank-trigger:active,
#profile-trigger:active {
transform: scale(0.92);
}
#rank-trigger span {
font-size: 1.8rem;
}
#profile-trigger img {
width: 80%;
height: 80%;
border-radius: 50%;
object-fit: cover;
}
/* –ü–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ: –ø—Ä–æ—Ñ–∏–ª—å ‚Äî —Å–ø—Ä–∞–≤–∞, —Ä–µ–π—Ç–∏–Ω–≥ ‚Äî —Å–ª–µ–≤–∞ –æ—Ç –Ω–µ–≥–æ */
#profile-trigger {
right: calc(16px + var(--safe-right));
}
#rank-trigger {
/* –°–¥–≤–∏–≥–∞–µ–º –≤–ª–µ–≤–æ –Ω–∞ —à–∏—Ä–∏–Ω—É –∫–Ω–æ–ø–∫–∏ + –æ—Ç—Å—Ç—É–ø */
right: calc(16px + 68px + 16px + var(--safe-right)); /* 16px (–æ—Ç—Å—Ç—É–ø –ø—Ä–æ—Ñ–∏–ª—è) + 68px (—à–∏—Ä–∏–Ω–∞ –ø—Ä–æ—Ñ–∏–ª—è) + 16px (–æ—Ç—Å—Ç—É–ø –º–µ–∂–¥—É –∫–Ω–æ–ø–∫–∞–º–∏) */
}
/* –°–∫—Ä—ã–≤–∞–µ–º –æ–±–µ –∫–Ω–æ–ø–∫–∏, –∫–æ–≥–¥–∞ –∞–∫—Ç–∏–≤–µ–Ω –ª—é–±–æ–π —ç–∫—Ä–∞–Ω, –∫—Ä–æ–º–µ –≥–ª–∞–≤–Ω–æ–≥–æ */
body:not(.show-main-screen) #rank-trigger,
body:not(.show-main-screen) #profile-trigger {
display: none;
}
/* –£–±–µ–¥–∏–º—Å—è, —á—Ç–æ –Ω–∞ –≥–ª–∞–≤–Ω–æ–º —ç–∫—Ä–∞–Ω–µ –æ–Ω–∏ –≤–∏–¥–Ω—ã */
body.show-main-screen #rank-trigger,
body.show-main-screen #profile-trigger {
display: flex;
}
/* --- –ö–û–ù–ï–¶ –ù–û–í–û–ô –°–¢–ò–õ–ò–ó–ê–¶–ò–ò --- */
.menu-buttons {
width: 100%;
max-width: 300px;
display: flex;
flex-direction: column;
gap: 16px;
margin-bottom: var(--safe-bottom);
}
.btn-wood {
background: #252528;
border: 1px solid rgba(255, 255, 255, 0.08);
color: #fff;
padding: 18px;
border-radius: 20px;
font-weight: 800;
font-size: 0.95rem;
text-transform: uppercase;
letter-spacing: 1.2px;
cursor: pointer;
transition: var(--transition);
text-align: center;
box-shadow: 0 4px 0px #151517;
position: relative;
top: 0;
user-select: none;
-webkit-tap-highlight-color: transparent;
}
.btn-wood:active {
top: 2px;
box-shadow: 0 1px 0px #151517;
background: #2a2a2d;
}
.btn-play {
background: var(--gold);
color: #000;
border: none;
box-shadow: 0 4px 0px #cca300;
}
.btn-play:active {
background: #e6b800;
box-shadow: 0 1px 0px #cca300;
}
.card {
background: var(--card);
padding: 32px 24px;
border-radius: var(--radius);
border: 1px solid rgba(255, 255, 255, 0.12);
width: 100%;
max-width: 340px;
backdrop-filter: blur(25px);
box-shadow: 0 25px 50px rgba(0, 0, 0, 0.7);
transform-origin: center bottom;
animation: cardPop 0.4s cubic-bezier(0.18, 0.89, 0.32, 1.28);
position: relative;
}
@keyframes cardPop {
from {
opacity: 0;
transform: scale(0.9) translateY(20px);
}
to {
opacity: 1;
transform: scale(1) translateY(0);
}
}
.stat-grid {
display: grid;
grid-template-columns: 1fr 1fr;
gap: 14px;
margin: 24px 0;
}
.stat-item {
background: rgba(255, 255, 255, 0.04);
padding: 16px;
border-radius: 20px;
text-align: center;
border: 1px solid rgba(255, 255, 255, 0.05);
}
.stat-val {
font-size: 1.2rem;
font-weight: 900;
display: block;
margin-bottom: 4px;
}
.stat-lbl {
font-size: 0.7rem;
opacity: 0.4;
text-transform: uppercase;
font-weight: 700;
}
input {
background: rgba(255, 255, 255, 0.06);
border: 1px solid rgba(255, 255, 255, 0.1);
color: #fff;
padding: 20px;
border-radius: 18px;
width: 100%;
box-sizing: border-box;
font-size: 1.2rem;
text-align: center;
margin-bottom: 16px;
font-weight: 700;
outline: none;
transition: border-color 0.2s;
}
input:focus {
border-color: var(--gold);
}
/* –ë–û–ô */
.arena {
position: absolute;
bottom: 25%;
width: 100%;
display: flex;
justify-content: space-around;
align-items: flex-end;
perspective: 1000px;
padding-bottom: var(--safe-bottom);
}
.boar-container {
width: 38%;
display: flex;
flex-direction: column;
align-items: center;
gap: 20px;
position: relative;
}
.boar-container.hit {
animation: flashRed 0.25s ease-out;
}
@keyframes flashRed {
0% {
filter: brightness(1);
}
50% {
filter: brightness(1.8) sepia(0.3) saturate(2);
transform: scale(1.1) rotate(2deg);
}
100% {
filter: brightness(1);
}
}
.dmg-popup {
position: absolute;
top: -40px;
color: #ff3e3e;
font-size: 2.2rem;
font-weight: 900;
text-shadow: 0 4px 12px rgba(0, 0, 0, 0.9);
pointer-events: none;
animation: flyUp 0.7s cubic-bezier(0.22, 1, 0.36, 1) forwards;
z-index: 100;
}
@keyframes flyUp {
0% {
opacity: 0;
transform: translateY(0) scale(0.5);
}
30% {
opacity: 1;
transform: translateY(-20px) scale(1.3);
}
100% {
opacity: 0;
transform: translateY(-90px) scale(1);
}
}
.hp-bar-box {
width: 100%;
max-width: 130px;
}
.hp-bar {
width: 100%;
background: rgba(255, 255, 255, 0.1);
height: 8px;
border-radius: 12px;
overflow: hidden;
position: relative;
box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.3);
}
.hp-fill {
height: 100%;
background: linear-gradient(90deg, #4cd964, #a0ffaf);
transition: width 0.4s cubic-bezier(0.33, 1, 0.68, 1);
width: 100%;
}
.hp-txt {
color: #fff;
font-size: 1.2rem;
font-weight: 900;
text-align: center;
margin-bottom: 8px;
text-shadow: 0 2px 8px rgba(0, 0, 0, 0.5);
}
.boar-unit {
width: 100%;
filter: drop-shadow(0 15px 25px rgba(0, 0, 0, 0.6));
}
.boar-unit img {
width: 100%;
height: auto;
display: block;
}
#boar1-img {
transform: scaleX(-1);
}
#fight-log {
position: absolute;
bottom: calc(15% + var(--safe-bottom));
background: rgba(0, 0, 0, 0.7);
backdrop-filter: blur(12px);
padding: 12px 28px;
border-radius: 100px;
font-weight: 700;
font-size: 0.9rem;
color: #fff;
border: 1px solid rgba(255, 255, 255, 0.15);
z-index: 20;
box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
max-width: 80%;
text-align: center;
}
/* –£–í–ï–î–û–ú–õ–ï–ù–ò–Ø / RESULT OVERLAY */
#result-overlay {
position: fixed;
inset: 0;
background: rgba(0, 0, 0, 0.8);
z-index: 5000;
display: none;
flex-direction: column;
align-items: center;
justify-content: center;
backdrop-filter: blur(12px);
padding: 24px;
padding-top: calc(24px + var(--safe-top));
padding-bottom: calc(24px + var(--safe-bottom));
padding-left: calc(24px + var(--safe-left));
padding-right: calc(24px + var(--safe-right));
box-sizing: border-box;
overflow-y: auto;
}
#result-card {
background: var(--card);
width: 100%;
max-width: 320px;
border-radius: 40px;
padding: 40px 24px;
text-align: center;
border: 1px solid rgba(255, 255, 255, 0.15);
transform: translateY(60px) scale(0.9);
opacity: 0;
transition: all 0.5s cubic-bezier(0.18, 0.89, 0.32, 1.28);
box-shadow: 0 40px 80px rgba(0, 0, 0, 0.9);
position: relative;
margin: auto;
display: flex;
flex-direction: column;
align-items: center;
}
#result-card.active {
transform: translateY(0) scale(1);
opacity: 1;
}
.res-icon {
font-size: 5rem;
margin-bottom: 20px;
display: block;
filter: drop-shadow(0 10px 20px rgba(0, 0, 0, 0.3));
}
.res-title {
font-size: 2.2rem;
font-weight: 900;
text-transform: uppercase;
margin: 0 0 12px 0;
word-break: break-word;
line-height: 1;
}
.res-sum {
font-size: 1.6rem;
font-weight: 800;
opacity: 0.9;
margin-bottom: 30px;
}
.res-btn {
background: #fff;
color: #000;
border: none;
padding: 18px 0;
width: 100%;
border-radius: 20px;
font-weight: 900;
font-size: 1.1rem;
text-transform: uppercase;
cursor: pointer;
box-shadow: 0 10px 30px rgba(255, 255, 255, 0.15);
transition: transform 0.2s;
display: flex;
align-items: center;
justify-content: center;
}
.res-btn:active {
transform: scale(0.96);
}
/* –ö–Ω–æ–ø–∫–∞ –∑–∞–∫—Ä—ã—Ç–∏—è (–∫—Ä–µ—Å—Ç–∏–∫) */
.close-x {
position: absolute;
top: 16px;
right: 16px;
width: 36px;
height: 36px;
background: rgba(255, 255, 255, 0.08);
border-radius: 50%;
display: flex;
align-items: center;
justify-content: center;
border: none;
color: rgba(255, 255, 255, 0.6);
font-size: 24px;
line-height: 1;
cursor: pointer;
transition: background 0.2s;
}
.close-x:active {
background: rgba(255, 255, 255, 0.2);
}
.rank-item {
display: flex;
justify-content: space-between;
align-items: center;
padding: 18px;
background: rgba(255, 255, 255, 0.04);
border-radius: 20px;
margin-bottom: 12px;
cursor: pointer;
border: 1px solid rgba(255, 255, 255, 0.05);
transition: background 0.2s;
}
.rank-item:active {
transform: scale(0.97);
background: rgba(255, 255, 255, 0.08);
}
/* --- –ù–û–í–´–ô –°–¢–ò–õ–¨: –í—ã–¥–µ–ª–µ–Ω–∏–µ —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (—Ç–æ–ª—å–∫–æ outline) --- */
.rank-item.current-user-highlight {
outline: 2px solid var(--gold); /* –¢–æ–ª—å–∫–æ —Ç–æ–Ω–∫–∞—è —Ä–∞–º–∫–∞ */
outline-offset: -2px; /* –ß—Ç–æ–±—ã —Ä–∞–º–∫–∞ –Ω–µ –≤—ã—Ö–æ–¥–∏–ª–∞ –∑–∞ –≥—Ä–∞–Ω–∏—Ü—ã —ç–ª–µ–º–µ–Ω—Ç–∞ */
/* background-color: rgba(255, 204, 0, 0.1); */ /* –£–¥–∞–ª–µ–Ω–æ */
}
/* --- –ö–û–ù–ï–¶ –ù–û–í–û–ì–û –°–¢–ò–õ–Ø --- */
/* --- –ù–û–í–´–ô –≠–õ–ï–ú–ï–ù–¢: –¢–µ–∫—Å—Ç "–¢–≤–æ–µ –º–µ—Å—Ç–æ" --- */
#your-rank {
font-size: 0.9rem;
opacity: 0.7;
margin-bottom: 16px;
text-align: center;
font-weight: 700;
}
/* --- –ö–û–ù–ï–¶ –ù–û–í–û–ì–û –≠–õ–ï–ú–ï–ù–¢–ê --- */
#user-modal {
position: fixed;
inset: 0;
background: rgba(0, 0, 0, 0.4);
z-index: 4000;
display: none;
flex-direction: column;
align-items: center;
justify-content: center;
padding: 24px;
box-sizing: border-box;
backdrop-filter: blur(15px);
padding-bottom: calc(24px + var(--safe-bottom));
}
/* –°—Ç–∏–ª–∏ –¥–ª—è —Ç—É–º–±–ª–µ—Ä–∞ */
.toggle-switch {
position: relative;
display: inline-block;
width: 120px;
height: 40px;
}
.toggle-switch input {
opacity: 0;
width: 0;
height: 0;
}
.slider {
position: absolute;
cursor: pointer;
top: 0;
left: 0;
right: 0;
bottom: 0;
background-color: var(--lose); /* –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –∫—Ä–∞—Å–Ω—ã–π (–ø—Ä–æ–¥–∞–∂–∞) */
transition: background-color 0.4s;
border-radius: 20px;
}
.slider:before {
position: absolute;
content: "";
height: 32px;
width: 32px;
left: 4px;
bottom: 4px;
background-color: #fff;
transition: transform 0.4s;
border-radius: 50%;
box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
}
input:checked + .slider {
background-color: var(--win); /* –∑–µ–ª—ë–Ω—ã–π –ø—Ä–∏ –ø–æ–∫—É–ø–∫–µ */
}
input:checked + .slider:before {
transform: translateX(76px); /* 120 - 32 - 4*2 = 76 */
}
/* --- –ù–û–í–´–ô –°–¢–ò–õ–¨: –ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å –º–∞–≥–∞–∑–∏–Ω–∞ --- */
.shop-grid {
display: grid;
grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
gap: 12px;
margin-top: 10px;
max-height: 300px; /* –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –≤—ã—Å–æ—Ç—É –¥–ª—è —Å–∫—Ä–æ–ª–ª–∞ */
overflow-y: auto; /* –î–æ–±–∞–≤–ª—è–µ–º —Å–∫—Ä–æ–ª–ª */
padding-right: 5px; /* –û—Ç—Å—Ç—É–ø –¥–ª—è –ø–æ–ª–æ—Å—ã */
/* –°—Ç–∏–ª–∏–∑–∞—Ü–∏—è —Å–∫—Ä–æ–ª–ª–∞ */
scrollbar-width: thin;
scrollbar-color: var(--gold) var(--card);
}
.shop-grid::-webkit-scrollbar {
width: 6px;
}
.shop-grid::-webkit-scrollbar-track {
background: var(--card);
border-radius: 10px;
}
.shop-grid::-webkit-scrollbar-thumb {
background-color: var(--gold);
border-radius: 10px;
border: 1px solid var(--card);
}
.shop-item {
background: rgba(255, 255, 255, 0.06);
border: 1px solid rgba(255, 255, 255, 0.1);
border-radius: 20px;
padding: 12px;
text-align: center;
cursor: pointer;
transition: background 0.2s;
}
.shop-item:active {
transform: scale(0.95);
background: rgba(255, 255, 255, 0.1);
}
.shop-item.selected {
background: rgba(255, 204, 0, 0.15);
border-color: var(--gold);
}
.shop-item-icon {
width: 40px;
height: 40px;
margin: 0 auto 8px;
}
.shop-item-name {
font-size: 0.75rem;
font-weight: 700;
margin: 0 0 4px;
}
.shop-item-price {
font-size: 0.7rem;
opacity: 0.6;
}
.shop-detail-section {
background: rgba(255, 255, 255, 0.04);
border: 1px solid rgba(255, 255, 255, 0.05);
border-radius: 20px;
padding: 16px;
margin-top: 16px;
display: flex;
flex-direction: column;
align-items: center;
gap: 12px;
}
.shop-detail-icon-big {
width: 80px;
height: 80px;
object-fit: contain; /* –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø—Ä–æ–ø–æ—Ä—Ü–∏–∏ */
}
.shop-quantity-controls {
display: flex;
align-items: center;
gap: 10px;
width: 100%;
justify-content: center;
}
.qty-btn {
width: 36px;
height: 36px;
border-radius: 50%;
background: #252528;
border: 1px solid rgba(255, 255, 255, 0.08);
color: #fff;
font-size: 1.2rem;
display: flex;
align-items: center;
justify-content: center;
cursor: pointer;
transition: background 0.2s;
}
.qty-btn:active {
background: #333;
}
#qty-val {
font-size: 1.2rem;
font-weight: 700;
min-width: 30px;
text-align: center;
}
.shop-actions {
display: flex;
gap: 12px;
width: 100%;
margin-top: 10px;
}
.btn-trade {
background: var(--win);
color: #000;
border: none;
box-shadow: 0 4px 0 #2d9a4a;
}
.btn-trade.sell-mode {
background: var(--lose);
color: #fff;
box-shadow: 0 4px 0 #cc2e27;
}
.btn-nav-back {
background: #7f8c8d;
color: #fff;
border: none;
box-shadow: 0 4px 0 #566573;
}
.btn-nav-back:active {
background: #6c7b8b;
box-shadow: 0 1px 0 #566573;
}
/* –ù–æ–≤—ã–µ —Å—Ç–∏–ª–∏ –¥–ª—è –≤–∞–ª—é—Ç –≤ –ª–∏–¥–µ—Ä–±–æ—Ä–¥–µ */
.lb-values {
display: flex;
flex-direction: column;
align-items: flex-end;
gap: 2px;
}
.lb-value-row {
display: flex;
align-items: center;
gap: 4px;
font-weight: 900;
}
.lb-val-gold {
color: var(--gold);
}
.lb-val-acorn {
color: #a0522d; /* –¶–≤–µ—Ç –∂–µ–ª—É–¥—è */
}
/* –ê–¥–∞–ø—Ç–∏–≤ –ø–æ–¥ –æ—á–µ–Ω—å —É–∑–∫–∏–µ —ç–∫—Ä–∞–Ω—ã */
@media (max-width: 360px) {
#profile-trigger, #rank-trigger {
width: 60px;
height: 60px;
right: 12px;
bottom: calc(16px + var(--safe-bottom));
}
.card {
padding: 24px 16px;
}
.menu-buttons {
max-width: 280px;
}
.res-title {
font-size: 1.8rem;
}
.res-icon {
font-size: 4rem;
}
}
</style>
</head>
<body>
<div id="bg-main" class="game-bg"></div>
<div id="bg-fight" class="game-bg"></div>
<div id="bg-inventory" class="game-bg"></div>
<div id="bg-shop" class="game-bg"></div>
<div class="bg-overlay"></div>
<div id="balance-header">
<span id="bal-val">0</span> üí∞
<!-- --- –ù–û–í–´–ô –≠–õ–ï–ú–ï–ù–¢: –ñ–µ–ª—É–¥–∏ --- -->
<span id="acorns-val">0</span> üå∞
<!-- --- –ö–û–ù–ï–¶ –ù–û–í–û–ì–û –≠–õ–ï–ú–ï–ù–¢–ê --- -->
</div>
<!-- --- –ù–û–í–´–ô –≠–õ–ï–ú–ï–ù–¢: –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ --- -->
<div id="notification-toast" class="notification-toast">
–≠—Ç–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞–ø—Ä–µ—Ç–∏–ª –µ–º—É –ø–∏—Å–∞—Ç—å
</div>
<!-- --- –ö–û–ù–ï–¶ –ù–û–í–û–ì–û –≠–õ–ï–ú–ï–ù–¢–ê --- -->
<!-- --- –ù–û–í–ê–Ø –ö–ù–û–ü–ö–ê –†–ï–ô–¢–ò–ù–ì–ê (üèÜ) --- -->
<div id="rank-trigger" onclick="nav('scr-rank')">
<span>üèÜ</span>
</div>
<!-- --- –ö–û–ù–ï–¶ –ù–û–í–û–ô –ö–ù–û–ü–ö–ò --- -->
<div id="profile-trigger" onclick="nav('scr-profile')">
<img src="assets/boar.png" onerror="this.src='https://api.dicebear.com/7.x/pixel-art/svg?seed=porker'">
</div>
<!-- –ó–∞–≥—Ä—É–∑–∫–∞ -->
<div id="scr-load" class="screen active">
<div style="width: 48px; height: 48px; border: 4px solid rgba(255,255,255,0.1); border-top-color: var(--gold); border-radius: 50%; animation: spin 0.8s cubic-bezier(0.5, 0, 0.5, 1) infinite;"></div>
</div>
<style>@keyframes spin {
to {
transform: rotate(360deg);
}
}</style>
<!-- –†–µ–∑—É–ª—å—Ç–∞—Ç –±–æ—è -->
<div id="result-overlay">
<div id="result-card">
<button class="close-x" onclick="closeResult()">&times;</button>
<span class="res-icon" id="res-icon">üèÜ</span>
<h2 class="res-title" id="res-title">–ü–û–ë–ï–î–ê</h2>
<div class="res-sum" id="res-sum">+500 üí∞</div>
<button class="res-btn" onclick="closeResult()">–ü–†–û–î–û–õ–ñ–ò–¢–¨</button>
</div>
</div>
<!-- –ú–æ–¥–∞–ª–∫–∞ –∏–≥—Ä–æ–∫–∞ -->
<div id="user-modal" onclick="if(event.target==this) closeModal()">
<div class="card">
<button class="close-x" onclick="closeModal()" style="top:12px; right:12px;">&times;</button>
<h3 id="modal-user-name" style="margin-top:0; font-size: 1.5rem; padding-right: 30px;">–ò–ì–†–û–ö</h3>
<!-- –°–ï–¢–ö–ê 2 —Å—Ç—Ä–æ–∫–∏ √ó 2 –∫–æ–ª–æ–Ω–∫–∏ -->
<div class="stat-grid" style="margin-top: 20px;">
<div class="stat-item">
<span class="stat-val" id="modal-games">0</span>
<span class="stat-lbl">–ë–û–ï–í</span>
</div>
<div class="stat-item">
<span class="stat-val" id="modal-wins" style="color: var(--win);">0</span>
<span class="stat-lbl">–ü–û–ë–ï–î</span>
</div>
<div class="stat-item">
<span class="stat-val" id="modal-lose" style="color: var(--lose);">0</span>
<span class="stat-lbl">–ü–û–†–ê–ñ.</span>
</div>
<div class="stat-item">
<span class="stat-val" id="modal-winrate">0%</span>
<span class="stat-lbl">WINRATE</span>
</div>
</div>
<!-- –ù–û–í–´–ï –ü–û–õ–Ø –î–õ–Ø –ü–†–û–§–ò–õ–Ø -->
<div class="stat-grid" style="margin-top: 15px;">
<div class="stat-item">
<span class="stat-val" id="modal-max-balance">0</span>
<span class="stat-lbl">–ú–ê–ö–°. –ë–ê–õ–ê–ù–°</span>
</div>
<div class="stat-item">
<span class="stat-val" id="modal-watched">0</span>
<span class="stat-lbl">–ü–†–û–°–ú–û–¢–†–ï–ù–û</span>
</div>
</div>
<button class="btn-wood" style="width: 100%; background: #0088cc; border:none; box-shadow: 0 4px 0 #006699;" id="modal-write-btn">–ù–ê–ü–ò–°–ê–¢–¨</button>
<button class="btn-wood" style="width: 100%; margin-top: 14px; opacity: 0.6;" onclick="closeModal()">–ó–ê–ö–†–´–¢–¨</button>
</div>
</div>
<div id="scr-main" class="screen">
<div class="menu-buttons">
<button class="btn-wood btn-play" onclick="nav('scr-bet')">–í –ë–û–ô</button>
<button class="btn-wood" onclick="nav('scr-inventory')">–ò–ù–í–ï–ù–¢–ê–†–¨</button>
<button class="btn-wood" onclick="nav('scr-shop')">–ú–ê–ì–ê–ó–ò–ù</button>
</div>
</div>
<div id="scr-bet" class="screen">
<div class="card">
<h3 style="margin-top:0; text-align: center; font-size: 1.4rem;">–í–ê–®–ê –°–¢–ê–í–ö–ê</h3>
<input type="number" id="bet-amt" value="100" min="10" inputmode="numeric">
<div style="display: flex; gap: 14px;">
<button class="btn-wood" style="flex:1; background: #3498db; border:none; box-shadow: 0 4px 0 #2573a7;" onclick="preStart(1)">–õ–ï–í–´–ô</button>
<button class="btn-wood" style="flex:1; background: #9b59b6; border:none; box-shadow: 0 4px 0 #7d4594;" onclick="preStart(2)">–ü–†–ê–í–´–ô</button>
</div>
<!-- --- –ù–û–í–ê–Ø –ö–ù–û–ü–ö–ê –°–õ–£–ß–ê–ô–ù–´–ô –ö–ê–ë–ê–ù --- -->
<button class="btn-wood" style="background: #e74c3c; border:none; box-shadow: 0 4px 0 #c0392b; margin: 8px auto; width: 80%; display: block;" onclick="startRandomBattle()">–ü–û–°–¢–ê–í–ò–¢–¨ –ù–ê –°–õ–£–ß–ê–ô–ù–û–ì–û</button>
<!-- --- –ö–û–ù–ï–¶ –ù–û–í–û–ô –ö–ù–û–ü–ö–ò --- -->
<button class="btn-wood" style="background: #7f8c8d; border:none; box-shadow: 0 4px 0 #566573; margin: 8px auto; width: 80%; display: block;" onclick="watchBattle()">–ü–û–°–ú–û–¢–†–ï–¢–¨ –ë–û–ô (+1)</button>
<button class="btn-wood" style="margin-top: 8px; width: 100%; opacity: 0.6;" onclick="nav('scr-main')">–û–¢–ú–ï–ù–ê</button>
</div>
</div>
<div id="scr-inventory" class="screen">
<div class="card" style="text-align: center;">
<h2 style="margin-top:0;">–ò–ù–í–ï–ù–¢–ê–†–¨</h2>
<p style="opacity:0.5; font-size: 0.95rem;">–†–∞–∑–¥–µ–ª –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ</p>
<div style="font-size: 6rem; margin: 30px 0;">üéí</div>
<button class="btn-wood" style="width: 100%;" onclick="nav('scr-main')">–ù–ê–ó–ê–î</button>
</div>
</div>
<!-- --- –ù–û–í–´–ô –≠–ö–†–ê–ù: –ú–ê–ì–ê–ó–ò–ù --- -->
<div id="scr-shop" class="screen">
<div class="card" style="max-height: 85vh; display: flex; flex-direction: column;">
<h3 style="margin-top:0; text-align: center;">–ú–ê–ì–ê–ó–ò–ù</h3>
<!-- --- –¢–£–ú–ë–õ–ï–† –ö–£–ü–ò–¢–¨ / –ü–†–û–î–ê–¢–¨ (–Ω–∞–¥–ø–∏—Å–∏ –°–ù–ê–†–£–ñ–ò) --- -->
<div class="shop-actions" style="margin-top: 10px; width: 100%; display: flex; align-items: center; justify-content: center; gap: 10px;">
<span class="label-left" style="font-size: 0.8rem; font-weight: 700; opacity: 0.7; color: #fff;">–ö–£–ü–ò–¢–¨</span>
<label class="toggle-switch" style="width: 120px; height: 40px; position: relative; display: inline-flex; align-items: center;">
<input type="checkbox" id="action-toggle" onchange="toggleAction()">
<span class="slider" style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: var(--lose); border-radius: 20px; cursor: pointer;"></span>
<span class="slider-thumb" style="position: absolute; top: 4px; left: 4px; width: 32px; height: 32px; background: #fff; border-radius: 50%; box-shadow: 0 4px 12px rgba(0,0,0,0.3); transition: transform 0.4s;"></span>
</label>
<span class="label-right" style="font-size: 0.8rem; font-weight: 700; opacity: 0.7; color: #fff;">–ü–†–û–î–ê–¢–¨</span>
</div>
<!-- --- –°–ï–¢–ö–ê –ü–†–ï–î–ú–ï–¢–û–í --- -->
<div id="shop-items-container" class="shop-grid" style="margin-top: 12px;">
<!-- JS –¥–æ–±–∞–≤–∏—Ç —ç–ª–µ–º–µ–Ω—Ç—ã -->
</div>
<!-- --- –î–ï–¢–ê–õ–ò –í–´–ë–†–ê–ù–ù–û–ì–û –ü–†–ï–î–ú–ï–¢–ê --- -->
<div class="shop-detail-section">
<!-- –ò–∫–æ–Ω–∫–∞: —Å–Ω–∞—á–∞–ª–∞ placeholder, –ø–æ—Ç–æ–º —Ä–µ–∞–ª—å–Ω–∞—è -->
<span id="detail-icon-placeholder" style="font-size: 4rem; opacity: 0.5;">üì¶</span>
<img id="detail-icon-big" class="shop-detail-icon-big" src="" alt="–ò–∫–æ–Ω–∫–∞ –ø—Ä–µ–¥–º–µ—Ç–∞" style="display: none;">
<div id="detail-name" style="font-size: 1.2rem; font-weight: 800;">–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–µ–¥–º–µ—Ç</div>
<div id="detail-price" style="font-size: 0.9rem; opacity: 0.7;">–¶–µ–Ω–∞: -</div>
<!-- --- –ü–û–õ–ï –í–í–û–î–ê –ö–û–õ–ò–ß–ï–°–¢–í–ê --- -->
<input type="number" id="qty-input" value="1" min="1" inputmode="numeric"
style="margin: 10px 0; width: 100%; padding: 16px; font-size: 1.4rem; text-align: center;
border-radius: 20px; background: rgba(255,255,255,0.06); border: 1px solid rgba(255,255,255,0.1);"
oninput="onQtyInput(this.value)">
<!-- --- –ò–¢–û–ì–û–í–ê–Ø –°–£–ú–ú–ê ‚Äî —Å–∫—Ä—ã—Ç–∞ –¥–æ –≤—ã–±–æ—Ä–∞ –ø—Ä–µ–¥–º–µ—Ç–∞ --- -->
<div id="total-cost" style="font-size: 1rem; font-weight: 700; color: var(--gold); text-align: center; margin-bottom: 12px; display: none;">
- üí∞ √ó - = - üí∞
</div>
<!-- --- –ö–ù–û–ü–ö–ê –°–î–ï–õ–ö–ò (—Ü–≤–µ—Ç –∑–∞–≤–∏—Å–∏—Ç –æ—Ç –¥–µ–π—Å—Ç–≤–∏—è) --- -->
<button class="btn-wood btn-trade" onclick="performTransaction()" style="width: 100%; margin-top: 10px;">–ö–£–ü–ò–¢–¨</button>
<!-- --- –ö–ù–û–ü–ö–ê –ù–ê–ó–ê–î --- -->
<button class="btn-wood btn-nav-back" onclick="nav('scr-main')">–ù–ê–ó–ê–î</button>
</div>
</div>
</div>
<!-- --- –ö–û–ù–ï–¶ –ù–û–í–û–ì–û –≠–ö–†–ê–ù–ê --- -->
<div id="scr-profile" class="screen">
<div class="card">
<h3 style="margin-top:0;">–í–ê–® –•–†–Ø–ö</h3>
<input type="text" id="edit-name" placeholder="–ò–º—è —Ö—Ä—è–∫–∞">
<div class="stat-grid">
<div class="stat-item"><span class="stat-val" id="st-games">0</span><span class="stat-lbl">–ë–æ–µ–≤</span></div>
<div class="stat-item"><span class="stat-val" id="st-wins" style="color: var(--win);">0</span><span class="stat-lbl">–ü–æ–±–µ–¥</span></div>
<div class="stat-item"><span class="stat-val" id="st-lose" style="color: var(--lose);">0</span><span class="stat-lbl">–ü–æ—Ä–∞–∂.</span></div>
<div class="stat-item"><span class="stat-val" id="st-wr">0%</span><span class="stat-lbl">Winrate</span></div>
</div>
<!-- –ù–û–í–´–ï –ü–û–õ–Ø –î–õ–Ø –ü–†–û–§–ò–õ–Ø -->
<div class="stat-grid">
<div class="stat-item"><span class="stat-val" id="st-max-balance">0</span><span class="stat-lbl">–ú–∞–∫—Å. –±–∞–ª–∞–Ω—Å</span></div>
<div class="stat-item"><span class="stat-val" id="st-watched">0</span><span class="stat-lbl">–ü—Ä–æ—Å–º–æ—Ç—Ä–µ–Ω–æ</span></div>
</div>
<div style="display: flex; align-items: center; justify-content: space-between; margin: 20px 0;">
<span>–ó–∞–ø—Ä–µ—Ç–∏—Ç—å –º–Ω–µ –ø–∏—Å–∞—Ç—å</span>
<label class="toggle-switch">
<input type="checkbox" id="private-profile-toggle" onchange="togglePrivateProfile()">
<span class="slider"></span>
</label>
</div>
<button class="btn-wood" style="width:100%; background: #fff; color: #000; box-shadow: 0 4px 0 #ccc;" onclick="updateName()">–°–û–•–†–ê–ù–ò–¢–¨</button>
<button class="btn-wood" style="width:100%; margin-top: 14px; opacity: 0.6;" onclick="nav('scr-main')">–ù–ê–ó–ê–î</button>
</div>
</div>
<div id="scr-rank" class="screen">
<div class="card" style="max-height: 85vh; display: flex; flex-direction: column;">
<h3 style="margin-top:0; text-align: center;">–¢–û–ü –ë–û–ô–¶–û–í</h3>
<!-- --- –ù–û–í–´–ô –≠–õ–ï–ú–ï–ù–¢: –¢–µ–∫—Å—Ç "–¢–≤–æ–µ –º–µ—Å—Ç–æ" --- -->
<div id="your-rank">–¢–≤–æ–µ –º–µ—Å—Ç–æ ‚Äî ?</div>
<!-- --- –ö–û–ù–ï–¶ –ù–û–í–û–ì–û –≠–õ–ï–ú–ï–ù–¢–ê --- -->
<div id="rank-loading" style="display: none; flex: 1; align-items: center; justify-content: center; flex-direction: column;">
<div style="width: 40px; height: 40px; border: 3px solid rgba(255,255,255,0.1); border-top-color: var(--gold); border-radius: 50%; animation: spin 0.8s cubic-bezier(0.5, 0, 0.5, 1) infinite; margin-bottom: 10px;"></div>
<span>–ó–∞–≥—Ä—É–∑–∫–∞...</span>
</div>
<div id="rank-list" style="overflow-y: auto; flex: 1; padding-right: 5px;"></div>
<button id="toggle-full-leaderboard" class="btn-wood" style="width:100%; margin-top: 10px; display: none;" onclick="toggleFullLeaderboard()">–†–∞–∑–≤–µ—Ä–Ω—É—Ç—å</button>
<button class="btn-wood" style="width:100%; margin-top: 10px;" onclick="nav('scr-main')">–ù–ê–ó–ê–î</button>
</div>
</div>
<div id="scr-fight" class="screen">
<div class="arena">
<div id="cont-1" class="boar-container">
<div class="hp-bar-box">
<div class="hp-txt" id="hp1-txt">100</div>
<div class="hp-bar"><div id="hp1-f" class="hp-fill"></div></div>
</div>
<div class="boar-unit">
<img id="boar1-img" src="assets/boar.png" onerror="this.src='https://api.dicebear.com/7.x/pixel-art/svg?seed=boar1'">
</div>
</div>
<div id="cont-2" class="boar-container">
<div class="hp-bar-box">
<div class="hp-txt" id="hp2-txt">100</div>
<div class="hp-bar"><div id="hp2-f" class="hp-fill"></div></div>
</div>
<div class="boar-unit">
<img id="boar2-img" src="assets/boar.png" onerror="this.src='https://api.dicebear.com/7.x/pixel-art/svg?seed=boar2'">
</div>
</div>
</div>
<div id="fight-log">–ü–û–î–ì–û–¢–û–í–ö–ê...</div>
</div>
<script>
const tg = window.Telegram.WebApp;
tg.expand();
let user = null;
let selectedSide = 0;
let isWatchingMode = false;
let fullLeaderboardLoaded = false;
let fullLeaderboardData = [];
let userRank = '?'; // –î–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –ø–æ–∑–∏—Ü–∏–∏
let currentShopItem = null; // –î–ª—è –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –ø—Ä–µ–¥–º–µ—Ç–∞ –≤ –º–∞–≥–∞–∑–∏–Ω–µ
let currentShopQuantity = 1; // –î–ª—è –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –≤ –º–∞–≥–∞–∑–∏–Ω–µ
let currentAction = 'buy'; // 'buy' –∏–ª–∏ 'sell'
let prices = {}; // –•—Ä–∞–Ω–µ–Ω–∏–µ —Ü–µ–Ω –∏–∑ prices.json
// --- –ù–û–í–´–ô –≠–ù–î–ü–û–ò–ù–¢ –î–õ–Ø –°–¢–ê–†–¢–ê –ë–û–Ø (SERVER-SIDE AUTHORITY) ---
async function startBattleServerSide(betAmount) {
const tgUser = tg.initDataUnsafe?.user || {id: "dev_user", username: "kaban", first_name: "–•—Ä—è–∫"};
const response = await fetch('/api/battle/start', {
method: 'POST',
headers: {'Content-Type': 'application/json'},
body: JSON.stringify({
tg_id: tgUser.id,
bet_amount: betAmount
})
});
if (!response.ok) {
const error = await response.json();
alert(error.error || '–û—à–∏–±–∫–∞ –Ω–∞—á–∞–ª–∞ –±–æ—è');
return null;
}
const result = await response.json();
if (result.success) {
// –û–±–Ω–æ–≤–ª—è–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–π –±–∞–ª–∞–Ω—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
user.balance = result.new_balance;
// –í–æ–∑–≤—Ä–∞—â–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
return {
isWin: result.is_win,
reward: result.reward
};
}
return null;
}
// --- –ö–û–ù–ï–¶ –ù–û–í–û–ì–û –≠–ù–î–ü–û–ò–ù–¢–ê ---
async function apiFetch(endpoint, options = {}) {
try {
const res = await fetch(endpoint, {
...options,
headers: {'Content-Type': 'application/json', ...(options.headers || {})
}
});
return await res.json();
} catch (e) {
return null;
}
}
// --- –ù–û–í–ê–Ø –§–£–ù–ö–¶–ò–Ø: –ó–∞–≥—Ä—É–∑–∫–∞ —Ü–µ–Ω –∏–∑ prices.json ---
async function loadPrices() {
try {
const response = await fetch('prices.json');
if (!response.ok) {
throw new Error('Network response was not ok');
}
prices = await response.json();
console.log("–¶–µ–Ω—ã –∑–∞–≥—Ä—É–∂–µ–Ω—ã:", prices);
} catch (error) {
console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ prices.json:", error);
// –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ü–µ–Ω—ã –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –≤ —Å–ª—É—á–∞–µ –æ—à–∏–±–∫–∏
prices = {
"plant_acorn": {"buy": 1000, "sell": 800},
"acorn": {"buy": 200, "sell": 150}
};
}
}
async function auth() {
const tgUser = tg.initDataUnsafe?.user || {id: "dev_user", username: "kaban", first_name: "–•—Ä—è–∫"};
user = await apiFetch('/api/auth', {
method: 'POST',
body: JSON.stringify({tg_id: tgUser.id, username: tgUser.username, first_name: tgUser.first_name})
});
if (user) {
updateUI();
nav('scr-main');
} else {
console.error("–ù–µ —É–¥–∞–ª–æ—Å—å –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞—Ç—å—Å—è");
showToast("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–æ—Ñ–∏–ª—è");
}
}
function updateUI() {
if (!user) return;
// --- –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï 2: –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–∞ –∏ –∂–µ–ª—É–¥–µ–π –≤ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–µ ---
document.getElementById('bal-val').innerText = user.balance.toLocaleString();
document.getElementById('acorns-val').innerText = user.acorns.toLocaleString(); // –û–±–Ω–æ–≤–ª—è–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∂–µ–ª—É–¥–µ–π
// --- –ö–û–ù–ï–¶ –ò–°–ü–†–ê–í–õ–ï–ù–ò–Ø 2 ---
document.getElementById('edit-name').value = user.display_name || user.username || "";
document.getElementById('st-games').innerText = user.total_games || 0;
document.getElementById('st-wins').innerText = user.wins || 0;
document.getElementById('st-lose').innerText = user.lose || 0;
const wr = user.total_games > 0 ? Math.round((user.wins / user.total_games) * 100) : 0;
document.getElementById('st-wr').innerText = wr + "%";
// –ù–û–í–û–ï: –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –Ω–æ–≤—ã—Ö –ø–æ–ª–µ–π –ø—Ä–æ—Ñ–∏–ª—è
document.getElementById('st-max-balance').innerText = (user.max_balance || 0).toLocaleString();
document.getElementById('st-watched').innerText = user.watched_battles || 0;
const toggle = document.getElementById('private-profile-toggle');
if (toggle) toggle.checked = !!user.private_profile;
}
function nav(id) {
document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
document.getElementById(id).classList.add('active');
// –û–±–Ω–æ–≤–ª—è–µ–º —Ñ–æ–Ω
document.getElementById('bg-main').style.display = 'block';
document.getElementById('bg-fight').style.display = 'none';
document.getElementById('bg-inventory').style.display = 'none';
document.getElementById('bg-shop').style.display = 'none';
if (id === 'scr-fight') {
document.getElementById('bg-main').style.display = 'none';
document.getElementById('bg-fight').style.display = 'block';
} else if (id === 'scr-inventory') {
document.getElementById('bg-main').style.display = 'none';
document.getElementById('bg-inventory').style.display = 'block';
} else if (id === 'scr-shop') {
document.getElementById('bg-main').style.display = 'none';
document.getElementById('bg-shop').style.display = 'block';
// ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –°–±—Ä–æ—Å —Å–æ—Å—Ç–æ—è–Ω–∏—è –º–∞–≥–∞–∑–∏–Ω–∞ –ø—Ä–∏ –≤—Ö–æ–¥–µ
resetShopState();
loadShopItems(); // –ó–∞–≥—Ä—É–∂–∞–µ–º –ø—Ä–µ–¥–º–µ—Ç—ã –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ –º–∞–≥–∞–∑–∏–Ω–∞
}
const isCardScreen = ['scr-bet', 'scr-inventory', 'scr-shop', 'scr-profile', 'scr-rank', 'scr-load'].includes(id);
document.body.classList.toggle('dimmed', isCardScreen);
// --- –ö–õ–Æ–ß–ï–í–û–ï –ò–ó–ú–ï–ù–ï–ù–ò–ï: –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–ª–∞—Å—Å –¥–ª—è –≥–ª–∞–≤–Ω–æ–≥–æ —ç–∫—Ä–∞–Ω–∞ ---
document.body.classList.toggle('show-main-screen', id === 'scr-main');
// ---------------------------------------------------------------
// –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É –ø—Ä–æ—Ñ–∏–ª—è —Ç–æ–ª—å–∫–æ –Ω–∞ –≥–ª–∞–≤–Ω–æ–º —ç–∫—Ä–∞–Ω–µ (—ç—Ç–æ –¥—É–±–ª–∏—Ä—É–µ—Ç CSS, –Ω–æ –Ω–∞–¥—ë–∂–Ω–µ–µ)
if (id === 'scr-main') {
document.body.classList.add('show-profile-btn');
} else {
document.body.classList.remove('show-profile-btn');
}
// –ó–∞–≥—Ä—É–∑–∫–∞ —Ä–µ–π—Ç–∏–Ω–≥–∞
if (id === 'scr-rank') loadRank(); // –ó–∞–≥—Ä—É–∂–∞–µ–º —Ä–µ–π—Ç–∏–Ω–≥ –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ —ç–∫—Ä–∞–Ω–∞
tg.HapticFeedback.impactOccurred('light');
}
// ‚úÖ –ù–û–í–ê–Ø –§–£–ù–ö–¶–ò–Ø: –°–±—Ä–æ—Å —Å–æ—Å—Ç–æ—è–Ω–∏—è –º–∞–≥–∞–∑–∏–Ω–∞ (–≤—ã–∑–æ–≤ –ø—Ä–∏ –≤—Ö–æ–¥–µ –∏ –ø—Ä–∏ –Ω–∞–∂–∞—Ç–∏–∏ –ù–ê–ó–ê–î)
function resetShopState() {
currentShopItem = null;
currentShopQuantity = 1;
document.getElementById('qty-input').value = '1';
document.getElementById('detail-icon-placeholder').style.display = 'block';
document.getElementById('detail-icon-big').style.display = 'none';
document.getElementById('detail-name').innerText = '–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–µ–¥–º–µ—Ç';
document.getElementById('detail-price').innerText = '–¶–µ–Ω–∞: -';
document.getElementById('total-cost').style.display = 'none';
// –°–Ω—è—Ç—å –≤—ã–¥–µ–ª–µ–Ω–∏–µ —Å–æ –≤—Å–µ—Ö –ø—Ä–µ–¥–º–µ—Ç–æ–≤
document.querySelectorAll('#shop-items-container .shop-item').forEach(el => el.classList.remove('selected'));
// –°–±—Ä–æ—Å–∏—Ç—å —Ç—É–º–±–ª–µ—Ä –≤ —Ä–µ–∂–∏–º "–ö–£–ü–ò–¢–¨" –∏ —Ü–≤–µ—Ç –≤ –∑–µ–ª—ë–Ω—ã–π
const toggle = document.getElementById('action-toggle');
toggle.checked = false;
currentAction = 'buy';
document.querySelector('.slider').style.backgroundColor = 'var(--win)';
document.querySelector('.slider-thumb').style.transform = 'translateX(0)';
updateTradeButton();
updatePriceDisplay();
}
// --- –ù–û–í–ê–Ø –§–£–ù–ö–¶–ò–Ø: –ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–µ–¥–º–µ—Ç–æ–≤ –º–∞–≥–∞–∑–∏–Ω–∞ ---
async function loadShopItems() {
// –°–Ω–∞—á–∞–ª–∞ –∑–∞–≥—Ä—É–∂–∞–µ–º —Ü–µ–Ω—ã
await loadPrices();
const container = document.getElementById('shop-items-container');
container.innerHTML = ""; // –û—á–∏—â–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
// –ò—Å–ø–æ–ª—å–∑—É–µ–º –∂–µ—Å—Ç–æ –∑–∞–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ id –ø—Ä–µ–¥–º–µ—Ç–æ–≤, –Ω–æ —Å —Ü–µ–Ω–∞–º–∏ –∏–∑ prices.json
const itemIds = ["acorn", "plant_acorn"];
for (const itemId of itemIds) {
const item = {
id: itemId,
name: itemId === "acorn" ? "–ñ–µ–ª—É–¥—å" : "–†–æ—Å—Ç–æ–∫",
icon: itemId === "acorn" ? "acorn.png" : "plant_acorn.png",
price: prices[itemId]?.buy || 0, // –¶–µ–Ω–∞ –ø–æ–∫—É–ø–∫–∏ –∏–∑ JSON
sell_price: prices[itemId]?.sell || 0 // –¶–µ–Ω–∞ –ø—Ä–æ–¥–∞–∂–∏ –∏–∑ JSON
};
const div = document.createElement('div');
div.className = 'shop-item';
div.onclick = () => selectShopItem(item);
div.innerHTML = `
<img class="shop-item-icon" src="assets/${item.icon}" onerror="this.src='https://placehold.co/40x40?text=?'">
<div class="shop-item-name">${item.name}</div>
<div class="shop-item-price">${currentAction === 'buy' ? item.price : item.sell_price} üí∞</div>
`;
container.appendChild(div);
}
}
// --- –ù–û–í–ê–Ø –§–£–ù–ö–¶–ò–Ø: –í—ã–±–æ—Ä –ø—Ä–µ–¥–º–µ—Ç–∞ –≤ –º–∞–≥–∞–∑–∏–Ω–µ ---
function selectShopItem(item) {
currentShopItem = item;
currentShopQuantity = 1;
document.getElementById('qty-input').value = currentShopQuantity;
// –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º –∏–∫–æ–Ω–∫—É
document.getElementById('detail-icon-placeholder').style.display = 'none';
document.getElementById('detail-icon-big').src = `assets/${item.icon}`;
document.getElementById('detail-icon-big').style.display = 'block';
document.getElementById('detail-name').innerText = item.name;
updatePriceDisplay();
// –ü–æ–¥—Å–≤–µ—Ç–∫–∞
document.querySelectorAll('#shop-items-container .shop-item').forEach(el => el.classList.remove('selected'));
event.currentTarget.classList.add('selected');
}
// --- –ù–û–í–ê–Ø –§–£–ù–ö–¶–ò–Ø: –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –¥–µ–π—Å—Ç–≤–∏—è (–ö–£–ü–ò–¢–¨/–ü–†–û–î–ê–¢–¨) ---
function toggleAction() {
const checkbox = document.getElementById('action-toggle');
const thumb = document.querySelector('#scr-shop .slider-thumb');
currentAction = checkbox.checked ? 'sell' : 'buy';
updatePriceDisplay(); // –û–±–Ω–æ–≤–ª—è–µ–º —Ü–µ–Ω—É –ø–æ–¥ –ø—Ä–µ–¥–º–µ—Ç–æ–º
updateShopItemPrices(); // –û–±–Ω–æ–≤–ª—è–µ–º —Ü–µ–Ω—ã –≤ —Å–µ—Ç–∫–µ –º–∞–≥–∞–∑–∏–Ω–∞
updateTradeButton(); // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–µ–∫—Å—Ç –∫–Ω–æ–ø–∫–∏ —Å–¥–µ–ª–∫–∏
// –ê–Ω–∏–º–∞—Ü–∏—è thumb
if (thumb) {
thumb.style.transform = checkbox.checked ? 'translateX(76px)' : 'translateX(0)';
}
// ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –û–±–Ω–æ–≤–ª—è–µ–º —Ü–≤–µ—Ç —Ñ–æ–Ω–∞ —Ç—É–º–±–ª–µ—Ä–∞
const slider = document.querySelector('.slider');
slider.style.backgroundColor = currentAction === 'buy' ? 'var(--win)' : 'var(--lose)';
}
// --- –ù–û–í–ê–Ø –§–£–ù–ö–¶–ò–Ø: –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞ –∫–Ω–æ–ø–∫–∏ —Å–¥–µ–ª–∫–∏ ---
function updateTradeButton() {
const button = document.querySelector('#scr-shop .btn-trade');
button.innerText = currentAction === 'buy' ? '–ö–£–ü–ò–¢–¨' : '–ü–†–û–î–ê–¢–¨';
button.classList.toggle('sell-mode', currentAction === 'sell');
}
// --- –ù–û–í–ê–Ø –§–£–ù–ö–¶–ò–Ø: –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ü–µ–Ω –≤ —Å–µ—Ç–∫–µ –º–∞–≥–∞–∑–∏–Ω–∞ ---
function updateShopItemPrices() {
const items = document.querySelectorAll('#shop-items-container .shop-item');
items.forEach((el, index) => {
const itemIds = ["acorn", "plant_acorn"];
const itemId = itemIds[index];
const item = {
id: itemId,
name: itemId === "acorn" ? "–ñ–µ–ª—É–¥—å" : "–†–æ—Å—Ç–æ–∫",
icon: itemId === "acorn" ? "acorn.png" : "plant_acorn.png",
price: prices[itemId]?.buy || 0,
sell_price: prices[itemId]?.sell || 0
};
el.querySelector('.shop-item-price').innerText = `${currentAction === 'buy' ? item.price : item.sell_price} üí∞`;
});
}
// --- –ù–û–í–ê–Ø –§–£–ù–ö–¶–ò–Ø: –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞ —Ü–µ–Ω—ã –ø–æ–¥ –ø—Ä–µ–¥–º–µ—Ç–æ–º –∏ –∏—Ç–æ–≥–æ–≤–æ–π —Å—É–º–º—ã ---
function updatePriceDisplay() {
const totalCostEl = document.getElementById('total-cost');
if (!currentShopItem) {
document.getElementById('detail-price').innerText = '–¶–µ–Ω–∞: -';
totalCostEl.style.display = 'none';
return;
}
const price = currentAction === 'buy' ? currentShopItem.price : currentShopItem.sell_price;
const total = price * currentShopQuantity;
document.getElementById('detail-price').innerText = `–¶–µ–Ω–∞: ${price} üí∞ / —à—Ç.`;
totalCostEl.innerHTML = `${price} üí∞ √ó ${currentShopQuantity} = ${total} üí∞`;
totalCostEl.style.display = 'block';
}
// --- –ù–û–í–ê–Ø –§–£–ù–ö–¶–ò–Ø: –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤–≤–æ–¥–∞ –≤ –ø–æ–ª–µ ---
function onQtyInput(value) {
let newQty = parseInt(value) || 1;
if (newQty < 1) newQty = 1;
if (newQty > 999999) newQty = 999999;
currentShopQuantity = newQty;
updatePriceDisplay(); // –û–±–Ω–æ–≤–ª—è–µ–º –∏—Ç–æ–≥–æ–≤—É—é —Å—É–º–º—É
}
// --- –ù–û–í–ê–Ø –§–£–ù–ö–¶–ò–Ø: –°–æ–≤–µ—Ä—à–µ–Ω–∏–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ ---
async function performTransaction() {
if (!currentShopItem) {
tg.HapticFeedback.notificationOccurred('error');
showToast("–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–µ–¥–º–µ—Ç");
return;
}
const endpoint = currentAction === 'buy' ? '/api/shop/buy' : '/api/shop/sell';
const payload = {
tg_id: user.tg_id,
item_id: currentShopItem.id,
quantity: currentShopQuantity
};
const response = await apiFetch(endpoint, {
method: 'POST',
body: JSON.stringify(payload)
});
if (response && response.success) {
// –û–±–Ω–æ–≤–ª—è–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
user.balance = response.new_balance;
user.acorns = response.new_acorns;
user.plant_acorns = response.new_plant_acorns;
// –û–±–Ω–æ–≤–ª—è–µ–º UI
updateUI();
tg.HapticFeedback.notificationOccurred('success');
showToast(`${currentAction === 'buy' ? '–ö—É–ø–ª–µ–Ω–æ' : '–ü—Ä–æ–¥–∞–Ω–æ'} ${currentShopQuantity}x ${currentShopItem.name}`);
} else {
tg.HapticFeedback.notificationOccurred('error');
showToast(response?.error || "–û—à–∏–±–∫–∞ –æ–ø–µ—Ä–∞—Ü–∏–∏");
}
}
// --- –ù–û–í–ê–Ø –§–£–ù–ö–¶–ò–Ø: –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–æ–∑–∏—Ü–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ---
function findUserRank(data) {
for (let i = 0; i < data.length; i++) {
if (data[i].tg_id === user.tg_id) {
return i + 1; // –ü–æ–∑–∏—Ü–∏—è –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å 1
}
}
return '?';
}
// --- –ù–û–í–ê–Ø –§–£–ù–ö–¶–ò–Ø: –†–∞—Å—á–µ—Ç –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ –¥–ª—è –±–∞–ª–∞–Ω—Å–∞ ---
function calculateProgress(userBalance, maxBalance) {
if (maxBalance <= 0) return 0;
return Math.min(100, (userBalance / maxBalance) * 100);
}
// --- –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï 1: –ò–∑–º–µ–Ω–µ–Ω–∏–µ —Ñ—É–Ω–∫—Ü–∏–∏ loadRank ---
async function loadRank() {
fullLeaderboardLoaded = false;
fullLeaderboardData = [];
document.getElementById('toggle-full-leaderboard').style.display = 'none';
document.getElementById('your-rank').textContent = '–¢–≤–æ–µ –º–µ—Å—Ç–æ ‚Äî ?';
document.getElementById('rank-loading').style.display = 'flex';
document.getElementById('rank-list').style.display = 'none';
const data = await apiFetch('/api/leaderboard');
const list = document.getElementById('rank-list');
list.innerHTML = "";
if (!data || !Array.isArray(data)) {
document.getElementById('your-rank').textContent = '–¢–≤–æ–µ –º–µ—Å—Ç–æ ‚Äî ?';
document.getElementById('rank-loading').style.display = 'none';
document.getElementById('rank-list').style.display = 'block';
return;
}
// –°–Ω–∞—á–∞–ª–∞ –∏—â–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ —Ç–µ–∫—É—â–µ–º —Å–ø–∏—Å–∫–µ
let userIndex = -1;
for (let i = 0; i < data.length; i++) {
if (data[i].tg_id === user?.tg_id) {
userIndex = i;
break;
}
}
// –ï—Å–ª–∏ –Ω–∞—à–ª–∏ ‚Äî —ç—Ç–æ –µ–≥–æ –º–µ—Å—Ç–æ
if (userIndex !== -1) {
userRank = userIndex + 1;
}
// –ï—Å–ª–∏ –Ω–µ –Ω–∞—à–ª–∏ ‚Äî –ø—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ–º, —á—Ç–æ –æ–Ω –Ω–∏–∂–µ —Ç–æ–ø-10
else {
// –ü—ã—Ç–∞–µ–º—Å—è —É—Ç–æ—á–Ω–∏—Ç—å: –µ—Å–ª–∏ –µ—Å—Ç—å –ø–æ–ª–µ `your_rank` –≤ –æ—Ç–≤–µ—Ç–µ ‚Äî –∏—Å–ø–æ–ª—å–∑—É–µ–º –µ–≥–æ
if (data.your_rank !== undefined && data.your_rank > 0) {
userRank = data.your_rank;
} else {
// –ò–Ω–∞—á–µ: —Å—Ç–∞–≤–∏–º –º–µ—Å—Ç–æ = –¥–ª–∏–Ω–∞ —Å–ø–∏—Å–∫–∞ + 1 (–Ω–∞–ø—Ä–∏–º–µ—Ä, 11, –µ—Å–ª–∏ —Ç–æ–ø-10)
userRank = data.length + 1;
}
}
// –û–±–Ω–æ–≤–ª—è–µ–º —Ç–µ–∫—Å—Ç –Ω–µ–∑–∞–≤–∏—Å–∏–º–æ –æ—Ç —Ç–æ–≥–æ, –Ω–∞–π–¥–µ–Ω –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
document.getElementById('your-rank').textContent = `–¢–≤–æ–µ –º–µ—Å—Ç–æ ‚Äî ${userRank}`;
// –†–µ–Ω–¥–µ—Ä–∏–º —Å–ø–∏—Å–æ–∫
const maxBalance = data.length > 0 ? data[0].balance : 0;
data.forEach((u, i) => {
const item = document.createElement('div');
item.className = 'rank-item';
if (user && u.tg_id === user.tg_id) {
item.classList.add('current-user-highlight');
}
item.innerHTML = `
<div style="display:flex; align-items:center; gap:12px;">
<span style="opacity:0.3; font-weight:900; width:24px; font-size: 0.8rem;">${i+1}</span>
<span style="font-weight:700;">${u.display_name || u.username}</span>
</div>
<div class="lb-values">
<div class="lb-value-row">
<span class="lb-val-gold">${u.balance.toLocaleString()} üí∞</span>
</div>
<div class="lb-value-row">
<span class="lb-val-acorn">${u.acorns ? u.acorns.toLocaleString() : '0'} üå∞</span>
</div>
</div>
`;
item.onclick = () => showUserDetail(u);
list.appendChild(item);
});
document.getElementById('rank-loading').style.display = 'none';
document.getElementById('rank-list').style.display = 'block';
document.getElementById('toggle-full-leaderboard').style.display = 'block';
document.getElementById('toggle-full-leaderboard').textContent = '–†–∞–∑–≤–µ—Ä–Ω—É—Ç—å';
}
// --- –ö–û–ù–ï–¶ –ò–°–ü–†–ê–í–õ–ï–ù–ò–Ø 1 ---
// --- –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï 1: –ò–∑–º–µ–Ω–µ–Ω–∏–µ —Ñ—É–Ω–∫—Ü–∏–∏ toggleFullLeaderboard ---
async function toggleFullLeaderboard() {
const button = document.getElementById('toggle-full-leaderboard');
const list = document.getElementById('rank-list');
if (!fullLeaderboardLoaded) {
button.textContent = '–ó–∞–≥—Ä—É–∑–∫–∞...';
button.disabled = true;
const data = await apiFetch('/api/leaderboard/full');
if (data) {
fullLeaderboardData = data;
fullLeaderboardLoaded = true;
// –û–±–Ω–æ–≤–ª—è–µ–º —Ç–µ–∫—Å—Ç "–¢–≤–æ–µ –º–µ—Å—Ç–æ" –¥–ª—è –ø–æ–ª–Ω–æ–≥–æ —Å–ø–∏—Å–∫–∞
userRank = findUserRank(data);
document.getElementById('your-rank').textContent = `–¢–≤–æ–µ –º–µ—Å—Ç–æ ‚Äî ${userRank}`;
// –ù–∞—Ö–æ–¥–∏–º –º–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π –±–∞–ª–∞–Ω—Å —Å—Ä–µ–¥–∏ –≤—Å–µ—Ö –∏–≥—Ä–æ–∫–æ–≤ –¥–ª—è –ø—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä–∞
const maxBalance = data.length > 0 ? data[0].balance : 0;
renderLeaderboard(fullLeaderboardData, true, maxBalance);
button.textContent = '–°–≤–µ—Ä–Ω—É—Ç—å';
} else {
button.textContent = '–û—à–∏–±–∫–∞';
setTimeout(() => button.textContent = '–†–∞–∑–≤–µ—Ä–Ω—É—Ç—å', 2000);
}
button.disabled = false;
} else {
fullLeaderboardLoaded = false;
loadRank(); // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Ç–æ–ø-10 (–∏ –æ–±–Ω–æ–≤–∏–º "–¢–≤–æ–µ –º–µ—Å—Ç–æ" –¥–ª—è —Ç–æ–ø-10)
}
}
// --- –ö–û–ù–ï–¶ –ò–°–ü–†–ê–í–õ–ï–ù–ò–Ø 1 ---
function renderLeaderboard(data, isFullList = false, maxBalanceOverride = null) {
const list = document.getElementById('rank-list');
list.innerHTML = "";
// –ï—Å–ª–∏ –Ω–µ –ø–µ—Ä–µ–¥–∞–ª–∏ maxBalance, –∏—Å–ø–æ–ª—å–∑—É–µ–º –ø–µ—Ä–≤—ã–π —ç–ª–µ–º–µ–Ω—Ç (–ª–∏–¥–µ—Ä–∞)
const maxBalance = maxBalanceOverride || (data.length > 0 ? data[0].balance : 0);
data.forEach((u, i) => {
const item = document.createElement('div');
item.className = 'rank-item';
if (user && u.tg_id === user.tg_id) {
item.classList.add('current-user-highlight');
}
// –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å –¥–ª—è –±–∞–ª–∞–Ω—Å–∞
const progress = calculateProgress(u.balance, maxBalance);
item.innerHTML = `
<div style="display:flex; align-items:center; gap:12px;">
<span style="opacity:0.3; font-weight:900; width:24px; font-size: 0.8rem;">${i+1}</span>
<span style="font-weight:700;">${u.display_name || u.username}</span>
</div>
<div class="lb-values">
<div class="lb-value-row">
<span class="lb-val-gold">${u.balance.toLocaleString()} üí∞</span>
</div>
<div class="lb-value-row">
<span class="lb-val-acorn">${u.acorns ? u.acorns.toLocaleString() : '0'} üå∞</span>
</div>
</div>
`;
item.onclick = () => showUserDetail(u);
list.appendChild(item);
});
}
// --- –ò–ó–ú–ï–ù–ï–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø: –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –¥–µ—Ç–∞–ª–µ–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ---
function showUserDetail(u) {
tg.HapticFeedback.selectionChanged();
// –ó–∞–ø–æ–ª–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
document.getElementById('modal-user-name').innerText = u.display_name || u.username;
document.getElementById('modal-games').innerText = u.total_games || 0;
document.getElementById('modal-wins').innerText = u.wins || 0;
document.getElementById('modal-lose').innerText = u.lose || 0;
// --- –ù–û–í–û–ï: –í—ã—á–∏—Å–ª–µ–Ω–∏–µ –≤–∏–Ω—Ä–µ–π—Ç–∞ ---
const wr = u.total_games > 0 ? Math.round((u.wins / u.total_games) * 100) : 0;
document.getElementById('modal-winrate').innerText = wr + "%";
// --- –ö–û–ù–ï–¶ –ù–û–í–û–ì–û ---
// –£–±–∏—Ä–∞–µ–º –±–∞–ª–∞–Ω—Å –∏–∑ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –≤ –º–æ–¥–∞–ª–∫–µ
// document.getElementById('modal-bal').innerText = u.balance.toLocaleString();
document.getElementById('modal-max-balance').innerText = (u.max_balance || 0).toLocaleString();
document.getElementById('modal-watched').innerText = (u.watched_battles || 0).toLocaleString();
const btn = document.getElementById('modal-write-btn');
if (u.username) {
btn.style.display = 'block';
btn.textContent = '–ù–ê–ü–ò–°–ê–¢–¨';
if (u.private_profile) {
// –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø—Ä–∏–≤–∞—Ç–Ω—ã–π
btn.style.background = '#7f8c8d'; // –°–µ—Ä—ã–π —Ü–≤–µ—Ç
btn.style.boxShadow = '0 4px 0 #566573'; // –°–µ—Ä–∞—è —Ç–µ–Ω—å
btn.onclick = () => {
showToast("–≠—Ç–æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞–ø—Ä–µ—Ç–∏–ª –µ–º—É –ø–∏—Å–∞—Ç—å"); // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
tg.HapticFeedback.notificationOccurred('error'); // –í–∏–±—Ä–∞—Ü–∏—è –æ–± –æ—à–∏–±–∫–µ
};
} else {
// –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø—É–±–ª–∏—á–Ω—ã–π
btn.style.background = '#0088cc'; // –°–∏–Ω–∏–π —Ü–≤–µ—Ç
btn.style.boxShadow = '0 4px 0 #006699'; // –°–∏–Ω—è—è —Ç–µ–Ω—å
btn.onclick = () => tg.openTelegramLink(`https://t.me/${u.username}`); // –û—Ç–∫—Ä—ã–≤–∞–µ–º Telegram
}
}
else {
// –ï—Å–ª–∏ —É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–µ—Ç username
btn.style.display = 'none';
btn.onclick = null;
}
// –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
document.getElementById('user-modal').style.display = 'flex';
}
// --- –ö–û–ù–ï–¶ –ò–ó–ú–ï–ù–Å–ù–ù–û–ô –§–£–ù–ö–¶–ò–ò ---
function closeModal() {
document.getElementById('user-modal').style.display = 'none';
}
async function togglePrivateProfile() {
const toggle = document.getElementById('private-profile-toggle');
const isChecked = toggle.checked;
const response = await apiFetch('/api/user/set-private', {
method: 'POST',
body: JSON.stringify({tg_id: user.tg_id, is_private: isChecked})
});
if (response && response.success) {
user.private_profile = isChecked;
console.log("–ü—Ä–æ—Ñ–∏–ª—å —Å—Ç–∞–ª", isChecked ? "–ø—Ä–∏–≤–∞—Ç–Ω—ã–º." : "–ø—É–±–ª–∏—á–Ω—ã–º.");
} else {
console.error("–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞ –ø—Ä–∏–≤–∞—Ç–Ω–æ—Å—Ç–∏:", response?.error || "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞");
toggle.checked = !isChecked;
}
}
function showToast(message) {
const toast = document.getElementById('notification-toast');
toast.textContent = message;
toast.classList.add('show');
setTimeout(() => toast.classList.remove('show'), 2500);
}
async function watchBattle() {
if (document.getElementById('scr-fight').classList.contains('active')) return;
isWatchingMode = true;
startFight(0);
}
async function updateName() {
const name = document.getElementById('edit-name').value;
if (!name) return;
await apiFetch('/api/user/update-name', {
method: 'POST',
body: JSON.stringify({tg_id: user.tg_id, display_name: name})
});
user.display_name = name;
tg.HapticFeedback.notificationOccurred('success');
nav('scr-main');
}
function preStart(side) {
const input = document.getElementById('bet-amt');
const amt = parseInt(input.value);
if (isNaN(amt) || amt < 10) return;
if (amt > user.balance) {
tg.HapticFeedback.notificationOccurred('error');
showResult("–û–®–ò–ë–ö–ê", "–ú–ê–õ–û –ó–û–õ–û–¢–ê", false);
return;
}
selectedSide = side;
isWatchingMode = false;
startFight(amt);
}
// --- –ù–û–í–ê–Ø –§–£–ù–ö–¶–ò–Ø: –°–ª—É—á–∞–π–Ω—ã–π –±–æ–π ---
function startRandomBattle() {
const input = document.getElementById('bet-amt');
const amt = parseInt(input.value);
if (isNaN(amt) || amt < 10) return;
if (amt > user.balance) {
tg.HapticFeedback.notificationOccurred('error');
showResult("–û–®–ò–ë–ö–ê", "–ú–ê–õ–û –ó–û–õ–û–¢–ê", false);
return;
}
// –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º selectedSide –≤ 0, —á—Ç–æ–±—ã –æ–±–æ–∑–Ω–∞—á–∏—Ç—å "—Å–ª—É—á–∞–π–Ω—ã–π"
selectedSide = 0;
isWatchingMode = false;
startFight(amt);
}
// --- –ö–û–ù–ï–¶ –ù–û–í–û–ô –§–£–ù–ö–¶–ò–ò ---
function showResult(title, sum, isWin) {
const overlay = document.getElementById('result-overlay');
const card = document.getElementById('result-card');
const t = document.getElementById('res-title');
const s = document.getElementById('res-sum');
const icon = document.getElementById('res-icon');
t.innerText = title;
s.innerText = sum;
icon.innerText = isWin ? "üèÜ" : "üíÄ";
overlay.style.display = 'flex';
setTimeout(() => card.classList.add('active'), 50);
}
function closeResult() {
const card = document.getElementById('result-card');
card.classList.remove('active');
setTimeout(() => {
document.getElementById('result-overlay').style.display = 'none';
if (!isWatchingMode) auth(); // –û–±–Ω–æ–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ—Å–ª–µ –±–æ—è
else nav('scr-main');
}, 300);
}
function spawnDmg(container, val) {
const p = document.createElement('div');
p.className = 'dmg-popup';
p.innerText = `-${val}`;
p.style.left = Math.random() * 40 + 30 + "%";
container.appendChild(p);
setTimeout(() => p.remove(), 700);
}
function startFight(bet) {
nav('scr-fight');
let h1 = 100, h2 = 100;
const log = document.getElementById('fight-log');
document.getElementById('hp1-f').style.width = "100%";
document.getElementById('hp2-f').style.width = "100%";
document.getElementById('hp1-txt').innerText = "100";
document.getElementById('hp2-txt').innerText = "100";
log.innerText = "–ë–û–ô –ù–ê–ß–ê–õ–°–Ø!";
// --- –ò–ó–ú–ï–ù–ï–ù–ò–ï: –õ–æ–≥–∏–∫–∞ –±–æ—è —Å —Å–µ—Ä–≤–µ—Ä–Ω—ã–º –≤—ã–∑–æ–≤–æ–º ---
let fightFinished = false;
let serverResult = null;
let finalIsWin = null; // –î–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è —Ñ–∏–Ω–∞–ª—å–Ω–æ–≥–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞
let finalReward = 0; // –î–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è —Ñ–∏–Ω–∞–ª—å–Ω–æ–π –Ω–∞–≥—Ä–∞–¥—ã/–ø–æ—Ç–µ—Ä—å
const runFightLogic = async () => {
if (isWatchingMode) {
// –î–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –±–æ—è –∏—Å–ø–æ–ª—å–∑—É–µ–º —Å—Ç–∞—Ä—ã–π —ç–Ω–¥–ø–æ–∏–Ω—Ç
const result = await apiFetch('/api/battle/watch', {
method: 'POST',
body: JSON.stringify({tg_id: user.tg_id})
});
if (result && result.new_balance !== undefined) {
user.balance = result.new_balance;
user.acorns = result.acorns;
user.plant_acorns = result.plant_acorns;
user.max_balance = result.max_balance;
user.watched_battles = result.watched_battles;
document.getElementById('bal-val').innerText = user.balance.toLocaleString();
document.getElementById('acorns-val').innerText = user.acorns.toLocaleString();
}
setTimeout(() => {
tg.HapticFeedback.notificationOccurred('success');
showResult("–ü–û–ë–ï–î–ê", "+" + (result.reward || 1) + " üí∞", true);
}, 1000);
fightFinished = true;
} else {
// –î–ª—è –æ–±—ã—á–Ω–æ–≥–æ –±–æ—è –∏—Å–ø–æ–ª—å–∑—É–µ–º –Ω–æ–≤—ã–π —Å–µ—Ä–≤–µ—Ä–Ω—ã–π —ç–Ω–¥–ø–æ–∏–Ω—Ç
serverResult = await startBattleServerSide(bet);
if (!serverResult) {
fightFinished = true;
return;
}
// –ë–æ–π –∑–∞–≤–µ—Ä—à–µ–Ω –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ, –Ω–æ –∞–Ω–∏–º–∞—Ü–∏—è –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç—Å—è
// –ú—ã –±—É–¥–µ–º —Å–∏–º—É–ª–∏—Ä–æ–≤–∞—Ç—å –∞–Ω–∏–º–∞—Ü–∏—é, –Ω–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç —É–∂–µ –∏–∑–≤–µ—Å—Ç–µ–Ω
// –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å–µ—Ä–≤–µ—Ä–Ω—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –∫–æ–Ω–µ—á–Ω–æ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è HP
// --- –ò–ó–ú–ï–ù–ï–ù–ò–ï: –£—á–∏—Ç—ã–≤–∞–µ–º —Å–ª—É—á–∞–π–Ω—ã–π –≤—ã–±–æ—Ä ---
let simulatedSide = selectedSide;
if (selectedSide === 0) { // –ï—Å–ª–∏ "—Å–ª—É—á–∞–π–Ω—ã–π"
simulatedSide = Math.random() > 0.5 ? 1 : 2; // –í—ã–±–∏—Ä–∞–µ–º —Å—Ç–æ—Ä–æ–Ω—É —Å–ª—É—á–∞–π–Ω–æ –¥–ª—è –∞–Ω–∏–º–∞—Ü–∏–∏
finalIsWin = serverResult.isWin; // –§–∏–Ω–∞–ª—å–Ω—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç - –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞
} else {
// –î–ª—è –æ–±—ã—á–Ω—ã—Ö –≤—ã–±–æ—Ä–æ–≤ —Ä–µ–∑—É–ª—å—Ç–∞—Ç –∑–∞–≤–∏—Å–∏—Ç –æ—Ç —Å–æ–≤–ø–∞–¥–µ–Ω–∏—è
finalIsWin = (selectedSide === 1 && serverResult.isWin) || (selectedSide === 2 && !serverResult.isWin);
}
finalReward = serverResult.reward;
// -----------------------------------------
const targetH1 = (simulatedSide === 1 && serverResult.isWin) || (simulatedSide === 2 && !serverResult.isWin) ? 100 : 0;
const targetH2 = (simulatedSide === 2 && serverResult.isWin) || (simulatedSide === 1 && !serverResult.isWin) ? 100 : 0;
const interval = setInterval(() => {
if (fightFinished) {
clearInterval(interval);
return;
}
const dmg = Math.floor(Math.random() * 12) + 6;
const target = Math.random() > 0.5 ? 1 : 2;
const cont = document.getElementById(`cont-${target}`);
cont.classList.add('hit');
spawnDmg(cont, dmg);
setTimeout(() => cont.classList.remove('hit'), 250);
if (target === 1) {
h1 = Math.max(0, h1 - dmg);
document.getElementById('hp1-f').style.width = h1 + "%";
document.getElementById('hp1-txt').innerText = h1;
} else {
h2 = Math.max(0, h2 - dmg);
document.getElementById('hp2-f').style.width = h2 + "%";
document.getElementById('hp2-txt').innerText = h2;
}
tg.HapticFeedback.impactOccurred('medium');
// –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –∑–∞–≤–µ—Ä—à–∞–µ–º –±–æ–π, –∫–æ–≥–¥–∞ HP –æ–¥–Ω–æ–≥–æ –∏–∑ –±–æ–π—Ü–æ–≤ –¥–æ—Å—Ç–∏–≥–∞–µ—Ç 0
if (h1 <= 0 || h2 <= 0) {
clearInterval(interval);
fightFinished = true;
// –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –ù–µ –º–µ–Ω—è–µ–º –≤–∏–∑—É–∞–ª—å–Ω—ã–µ HP –Ω–∞ —Å–µ—Ä–≤–µ—Ä–Ω—ã–µ, –µ—Å–ª–∏ –±–æ–π —É–∂–µ –≤–∏–∑—É–∞–ª—å–Ω–æ –∑–∞–∫–æ–Ω—á–µ–Ω
// –ó–∞–∫—Ä–µ–ø–ª—è–µ–º —Ñ–∏–Ω–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ HP, –µ—Å–ª–∏ –æ–Ω–∏ —É–∂–µ –Ω—É–ª–µ–≤—ã–µ
if (h1 <= 0) {
h1 = 0;
document.getElementById('hp1-f').style.width = '0%';
document.getElementById('hp1-txt').innerText = '0';
} else if (h2 <= 0) {
h2 = 0;
document.getElementById('hp2-f').style.width = '0%';
document.getElementById('hp2-txt').innerText = '0';
}
// –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
setTimeout(() => {
// --- –ò–ó–ú–ï–ù–ï–ù–ò–ï: –ò—Å–ø–æ–ª—å–∑—É–µ–º finalIsWin –∏ finalReward ---
if (finalIsWin) {
tg.HapticFeedback.notificationOccurred('success');
showResult("–ü–û–ë–ï–î–ê", `+${finalReward} üí∞`, true);
} else {
tg.HapticFeedback.notificationOccurred('error');
showResult("–ü–û–†–ê–ñ–ï–ù–ò–ï", `${finalReward} üí∞`, false);
}
// ----------------------------------------------
}, 1000);
}
}, 700);
}
};
runFightLogic();
}
auth();
</script>
</body>
</html>